Nehan.Document = (function(){
  function Document(opt){
    opt = opt || {};
    this.text = opt.text || "no text";
    this.styles = opt.styles || {};
    this.generator = null; // created when render
  }

  Document.prototype.render = function(opt){
    opt = opt || {};
    var context = new Nehan.RenderingContext({
      text:Nehan.Html.normalize(this.text)
    }).setStyles(this.styles);
    this.text = opt.text || this.text;
    this.generator = context.createRootGenerator();
    if(opt.onPage){
      var original_onprogress = opt.onProgress || function(){};
      opt.onProgress = function(tree, ctx){
	original_onprogress(tree, ctx);
	opt.onPage(this.getPage(tree.pageNo), ctx);
      }.bind(this);
    }
    new Nehan.PageParser(this.generator).parse(opt);
    return this;
  };
  
  Document.prototype.getPage = function(index){
    return this.generator.context? this.generator.context.getPage(index) : null;
  };

  Document.prototype.getPageCount = function(index){
    return this.generator.context? this.generator.context.getPageCount() : 0;
  };

  Document.prototype.setContent = function(text){
    this.text = text;
    return this;
  };

  Document.prototype.getContent = function(text){
    return this.text;
  };

  Document.prototype.setStyle = function(key, value){
    this.styles[key] = value;
    return this;
  };

  Document.prototype.setStyles = function(values){
    for(var key in values){
      this.setStyle(key, values[key]);
    }
    return this;
  };

  Document.prototype.getAnchorPageNo = function(anchor_name){
    return this.generator.context? this.generator.context.getAnchorPageNo(anchor_name) : -1;
  };

  Document.prototype.createOutlineElement = function(callbacks){
    return this.generator.context? this.generator.context.createOutlineElementByName("body", callbacks) : null;
  };

  return Document;
})();
