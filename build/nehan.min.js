/*
 nehan.js
 Copyright (C) 2013-, Watanabe Masaki<lambda.watanabe[at]gmail.com>

 licenced under MIT licence.

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/

var Nehan;Nehan||(Nehan={}),Nehan.setup=function(t){var e=t||{},n={lang:"ja-JP",debug:!0,kerning:!0,justify:!0,maxRollbackCount:10,minBlockScaleDownRate:65,lexingBufferLen:2e3,enableEvents:{onReadyMarkup:!0,onReadyBox:!0,onCreateBox:!0}},i={direction:"vert",hori:"lr-tb",vert:"tb-rl",width:800,height:580,fontSize:16,rubyRate:.5,boldRate:.2,listMarkSpacingRate:.2,fontColor:"000000",linkColor:"0000FF",fontImgRoot:"http://nehan.googlecode.com/hg/char-img",lineRate:2,alignedSpacingRate:.5,listMarkerSpacingRate:.5,createBox:function(t,e,n){var i=new X(t,e,n);return i.flow=e.flow,i.lineRate=e.lineRate,i.textAlign=e.textAlign,i.fontSize=e.fontSize,i.color=e.color,i},createStdBox:function(t){var e=this.getStdBoxFlow(),n=this.getStdPageSize(),i=new X(n,null,t);return i.flow=e,i.lineRate=this.lineRate,i.textAlign="start",i.fontSize=this.fontSize,i.color=this.fontColor,i},getStdPageSize:function(){return new j(this.width,this.height)},getStdBoxFlow:function(){var t=this[this.direction];return N.getByName(t)},getStdVertFlow:function(){return N.getByName(this.vert)},getStdHoriFlow:function(){return N.getByName(this.hori)},getAlignedSpacingSize:function(){return Math.floor(this.fontSize*this.alignedSpacingRate)},getListMarkerSpacingSize:function(t){return Math.floor(t*this.listMarkerSpacingRate)},getVertBlockDir:function(){return this.vert.split("-")[1]},getHoriIndir:function(){return this.hori.split("-")[0]}},r=function(){var t,e,n,i=navigator.appName,r=navigator.userAgent.toLowerCase(),s=r.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/);s?(tmp_match=r.match(/version\/([\.\d]+)/i),tmp_match&&(s[2]=tmp_match[1]),t=s[1].toLowerCase(),e=parseInt(s[2],10),n="msie"===t?this.version>=9:!0):(t=i.toLowerCase(),e=parseInt(navigator.appVersion,10),n=!1);var a="msie"===t,o=r.indexOf("windows")>=0,u=r.indexOf("macintosh")>=0,h=t.indexOf("chrome")>=0,l=-1!=r.indexOf("iphone"),c=-1!=r.indexOf("ipod"),f=-1!=r.indexOf("ipad"),g=l||c||f,d=-1!=r.indexOf("android"),p=g||d,m=-1!=r.indexOf("webkit"),k=h&&(o||u)&&e>=24;return{version:e,isIE:a,isChrome:h,isWebkit:m,isIphone:l,isIpod:c,isIpad:f,isIphoneFamily:g,isAndroidFamily:d,isSmartPhone:p,isTransformEnable:n,isVerticalGlyphEnable:k}}(),s={a:{display:"inline"},abbr:{display:"inline"},address:{display:"inline",section:!0},area:{},article:{display:"block","child-content":!0,section:!0},aside:{display:"block","child-content":!0,section:!0},audio:{},b:{display:"inline"},base:{},bdi:{display:"inline"},bdo:{display:"inline"},blockquote:{display:"block","child-content":!0,"section-root":!0,margin:{start:"1.5em",end:"1.5em",before:"1.5em",after:"1.5em"}},body:{display:"block","child-content":!0,"section-root":!0},br:{display:"inline",single:!0},button:{display:"inline",interactive:!0},canvas:{display:"inline",embeddable:!0},caption:{display:"block","text-align":"center","child-content":!0,margin:{after:"0.5em"}},cite:{display:"inline"},code:{display:"inline"},col:{},colgroup:{},command:{},datalist:{},dd:{display:"block","child-content":!0,margin:{start:"1em",end:"1em",after:"1.6em"}},del:{display:"inline"},details:{display:"block","child-content":!0,"section-root":!0},dfn:{display:"inline"},div:{display:"block",embeddable:!0,"child-content":!0},dl:{display:"block","child-content":!0},dt:{display:"block","child-content":!0,margin:{after:"0.2em"}},em:{display:"inline"},embed:{},"end-page":{display:"block",single:!0},fieldset:{display:"block","child-content":!0,"section-root":!0,padding:{start:"1em",end:"0.2em",before:"0.2em",after:"1em"},margin:{after:"1.5em"},border:"1px"},figure:{display:"block","child-content":!0,"section-root":!0},figcaption:{display:"block","child-content":!0,"text-align":"center","font-size":"0.8em"},footer:{display:"block","child-content":!0,section:!0},form:{display:"block","child-content":!0},h1:{display:"block","line-rate":1.4,"child-content":!0,"font-size":"2.4em",margin:{after:"0.5em"}},h2:{display:"block","line-rate":1.4,"child-content":!0,"font-size":"2.0em",margin:{after:"0.75em"}},h3:{display:"block","line-rate":1.4,"child-content":!0,"font-size":"1.6em",margin:{after:"1em"}},h4:{display:"block","line-rate":1.4,"child-content":!0,"font-size":"1.4em",margin:{after:"1.25em"}},h5:{display:"block","line-rate":1.4,"child-content":!0,"font-size":"1.0em",margin:{after:"1.5em"}},h6:{display:"block","line-rate":1.4,"child-content":!0,"font-size":"1.0em"},head:{"child-content":!0},header:{display:"block","child-content":!0,section:!0},hr:{display:"block",single:!0,margin:{after:"1em"},border:{after:"1px"}},"hr.nehan-space":{border:0},html:{display:"block","child-content":!0},i:{display:"inline"},iframe:{display:"block","child-content":!0,embeddable:!0},ins:{},img:{display:"inline",single:!0,margin:{before:"0.5em",after:"0.5em"}},input:{display:"inline",interactive:!0,single:!0},kbd:{display:"inline"},keygen:{},label:{display:"inline"},legend:{display:"block","line-rate":1.5,"child-content":!0},li:{display:"block","child-content":!0,margin:{after:"0.6em"}},link:{meta:!0,single:!0},map:{},mark:{display:"inline"},menu:{display:"block","child-content":!0},meta:{meta:!0,single:!0},meter:{display:"inline"},nav:{display:"block","child-content":!0,section:!0},noscript:{},object:{display:"inline",embeddable:!0},ol:{display:"block","child-content":!0,"list-style-image":"none","list-style-position":"outside","list-style-type":"decimal",margin:{before:"1em"}},optgroup:{},option:{},output:{},p:{display:"block","child-content":!0,margin:{after:"1.5em"}},"page-break":{display:"block",single:!0},param:{},pre:{display:"block","child-content":!0},progress:{display:"inline"},q:{display:"block","child-content":!0},rb:{display:"inline"},rp:{display:"inline"},ruby:{"child-content":!0,"font-size":"0.5em",display:"inline"},rt:{display:"inline","child-content":!0},s:{display:"inline"},samp:{display:"inline"},script:{display:"inline","child-content":!0,meta:!0},section:{display:"block","child-content":!0,section:!0},select:{},small:{display:"inline","font-size":"0.8em"},source:{},span:{display:"inline"},strong:{display:"inline"},style:{display:"inline",meta:!0,"child-content":!0},sub:{display:"inine"},summary:{display:"inline"},sup:{display:"inine"},table:{display:"block","child-content":!0,embeddable:!0,"table-layout":"fixed","border-collapse":"collapse","border-spacing":"5px",border:"1px",margin:{start:"0.5em",end:"0.5em",after:"1.6em"}},tbody:{display:"block","border-collapse":"inherit","child-content":!0},td:{display:"block","border-collapse":"inherit","child-content":!0,"section-root":!0,border:"1px",padding:{start:"0.8em",end:"0.8em",before:"0.5em",after:"0.5em"}},textarea:{display:"inline","child-content":!0,embeddable:!0,interactive:!0},tfoot:{display:"block","border-collapse":"inherit","child-content":!0},th:{display:"block","line-rate":1.4,"border-collapse":"inherit","child-content":!0,border:"1px",padding:{start:"0.8em",end:"0.8em",before:"0.5em",after:"0.5em"}},thead:{display:"block","border-collapse":"inherit","child-content":!0},time:{display:"inline"},title:{meta:!0,"child-content":!0},tr:{display:"block","child-content":!0},track:{},u:{display:"inline"},ul:{display:"block","child-content":!0,"list-style-image":"none","list-style-type":"disc","list-style-position":"outside",margin:{before:"1em"}},"var":{display:"inline"},video:{display:"inline",embeddable:!0},wbr:{display:"inline",single:!0},":before":{display:"inline-block","child-content":!0,"line-rate":1},":after":{display:"inline-block","child-content":!0,"line-rate":1},":first-letter":{display:"inline-block","child-content":!0},":first-line":{display:"inline"},".nehan-rounded":{padding:["1.6em","1.0em","1.6em","1.0em"],border:{radius:"10px"}},".nehan-xx-large":{"font-size":"33px"},".nehan-x-large":{"font-size":"24px"},".nehan-large":{"font-size":"18px"},".nehan-medium":{"font-size":"16px"},".nehan-small":{"font-size":"13px"},".nehan-x-small":{"font-size":"10px"},".nehan-xx-small":{"font-size":"10px"},".nehan-larger":{"font-size":"1.2em"},".nehan-smaller":{"font-size":"0.8em"},".nehan-disp-block":{display:"block"},".nehan-disp-inline":{display:"inline"},".nehan-disp-inline-block":{display:"inline-block"},".nehan-pb-before":{"page-break-before":"always"},".nehan-pb-after":{"page-break-after":"always"},".nehan-ta-start":{"text-align":"start"},".nehan-ta-center":{"text-align":"center"},".nehan-ta-end":{"text-align":"end"},".nehan-ba-start":{"block-align":"start"},".nehan-ba-end":{"block-align":"end"},".nehan-flow-lr-tb":{flow:"lr-tb"},".nehan-flow-tb-rl":{flow:"tb-rl"},".nehan-flow-tb-lr":{flow:"tb-lr"},".nehan-flow-rl-tb":{flow:"rl-tb"},".nehan-flow-flip":{flow:"flip"},".nehan-flow-inherit":{"float":"inherit"},".nehan-lsp-inside":{"list-style-position":"inside"},".nehan-lsp-outside":{"list-style-position":"outside"},".nehan-lst-none":{"list-style-type":"none"},".nehan-lst-decimal":{"list-style-type":"decimal"},".nehan-lst-disc":{"list-style-type":"disc"},".nehan-lst-circle":{"list-style-type":"circle"},".nehan-lst-square":{"list-style-type":"square"},".nehan-lst-decimal-leading-zero":{"list-style-type":"decimal-leading-zero"},".nehan-lst-lower-alpha":{"list-style-type":"lower-alpha"},".nehan-lst-upper-alpha":{"list-style-type":"upper-alpha"},".nehan-lst-lower-latin":{"list-style-type":"lower-latin"},".nehan-lst-upper-latin":{"list-style-type":"upper-latin"},".nehan-lst-lower-roman":{"list-style-type":"lower-roman"},".nehan-lst-upper-roman":{"list-style-type":"upper-roman"},".nehan-lst-lower-greek":{"list-style-type":"lower-greek"},".nehan-lst-upper-greek":{"list-style-type":"upper-greek"},".nehan-lst-cjk-ideographic":{"list-style-type":"cjk-ideographic"},".nehan-lst-hiragana":{"list-style-type":"hiragana"},".nehan-lst-hiragana-iroha":{"list-style-type":"hiragana-iroha"},".nehan-lst-katakana":{"list-style-type":"katakana"},".nehan-lst-katakana-iroha":{"list-style-type":"katakana-iroha"},".nehan-tcy":{"text-combine":"horizontal"},".nehan-text-combine":{"text-combine":"horizontal"},".nehan-empha-dot-filled":{"empha-mark":"&#x2022;"},".nehan-empha-dot-open":{"empha-mark":"&#x25e6;"},".nehan-empha-circle-filled":{"empha-mark":"&#x25cf;"},".nehan-empha-circle-open":{"empha-mark":"&#x25cb;"},".nehan-empha-double-circle-open":{"empha-mark":"&#x25ce;"},".nehan-empha-double-circle-filled":{"empha-mark":"&#x25c9;"},".nehan-empha-triangle-filled":{"empha-mark":"&#x25b2;"},".nehan-empha-triangle-open":{"empha-mark":"&#x25b3;"},".nehan-empha-sesame-filled":{"empha-mark":"&#xfe45;"},".nehan-empha-sesame-open":{"empha-mark":"&#xfe46;"},".nehan-tip":{padding:{before:"0.1em",start:"0.8em",end:"0.8em",after:"0.8em"},margin:{after:"1em"},border:"2px"},".nehan-drop-caps:first-letter":{display:"block",flow:"inherit",width:"4em",height:"4em","block-align":"start","line-rate":1,"font-size":"4em"},".nehan-line-no-ruby":{"line-rate":1},".nehan-append-after":{margin:{after:"1em"}},".nehan-prepend-before":{margin:{before:"1em"}},".nehan-ti-1em":{"text-indent":"1em"},".nehan-jisage":{"text-indent":"1em"}},a={_sources:{".nehan-aside":{onReadyBox:function(t){var e=t.box;e.blockAlign=e.isTextVertical()?"start":"end"}}},_getSource:function(t){return this._sources[t]||null},_getHandler:function(t,e){var n=this._sources[t]||null;return n?n[e]||null:null},isEnable:function(t){return n.enableEvents[t]||!1},callHandlers:function(t,e,n){var i=this;u.iter(t,function(t){i.callHandler(t,e,n)})},callHandler:function(t,e,n){var i=this._getHandler(t,e);return i?i(n):void 0},addEventListener:function(t,e,n){var i=this._getSource(t);null===i&&(i={},this._sources[t]=i),i[e]===void 0&&(i[e]=n)}},o=function(){var t=!1,e=/xyz/.test(function(){})?/\b_super\b/:/.*/,n=function(){};return n.extend=function(n){function i(){!t&&this.init&&this.init.apply(this,arguments)}var r=this.prototype;t=!0;var s=new this;t=!1;for(var a in n)s[a]="function"==typeof n[a]&&"function"==typeof r[a]&&e.test(n[a])?function(t,e){return function(){var n=this._super;this._super=r[t];var i=e.apply(this,arguments);return this._super=n,i}}(a,n[a]):n[a];return i.prototype=s,i.prototype.constructor=i,i.extend=arguments.callee,i},n}(),u={each:function(t,e){for(var n in t)e(n,t[n])},iter:function(t,e){for(var n=0,i=t.length;i>n;n++)e(t[n])},iteri:function(t,e){for(var n=0,i=t.length;i>n;n++)e(n,t[n])},reviter:function(t,e){for(var n=t.length;n>=0;n--)e(t[n])},reviteri:function(t,e){for(var n=t.length;n>=0;n--)e(n,t[n])},forall:function(t,e){for(var n=0,i=t.length;i>n;n++)if(!e(t[n]))return!1;return!0},map:function(t,e){for(var n=[],i=0,r=t.length;r>i;i++)n[i]=e(t[i]);return n},mapi:function(t,e){for(var n=[],i=0,r=t.length;r>i;i++)n[i]=e(i,t[i]);return n},fold:function(t,e,n){for(var i=e,r=0,s=t.length;s>r;r++)i=n(i,t[r]);return i},filter:function(t,e){for(var n=[],i=0,r=t.length;r>i;i++)e(t[i])&&n.push(t[i]);return n},find:function(t,e){for(var n=0,i=t.length;i>n;n++){var r=t[n];if(e(r))return r}return null},revfind:function(t,e){for(var n=t.length-1;n>=0;n--){var i=t[n];if(e(i))return i}return null},exists:function(t,e){for(var n=0,i=t.length;i>n;n++)if(e(t[n]))return!0;return!1},mem:function(t,e){for(var n=0,i=t.length;i>n;n++)if(t[n]==e)return!0;return!1},sum:function(t){return this.fold(t,0,function(t,e){return t+e})},minobj:function(t,e){var n=null,i=null;return this.iter(t,function(t){var r=e(t);(null===i||i>r)&&(n=t,i=r)}),n},maxobj:function(t,e){var n=null,i=null;return this.iter(t,function(t){var r=e(t);(null===i||r>i)&&(n=t,i=r)}),n},refcopy:function(t){for(var e=[],n=0,i=t.length;i>n;n++)e[n]=t[n];return e},count:function(t,e){for(var n=0,i=0,r=t.length;r>i;i++)e(t[i])&&n++;return n},create:function(t,e){var n=Array(t);if(e!==void 0)for(var i=0;t>i;i++)n[i]=e;return n}},h={isEmpty:function(t){for(var e in t)return!1;return!0},iter:function(t,e){for(var n in t)e(t,n,t[n])}},l={mapFontSize:function(t,e){var n="string"==typeof t?t:t+"";if(n.indexOf("em")>0){var i=parseFloat(n.replace("em",""));return Math.floor(e*i)}if(n.indexOf("pt")>0)return Math.floor(4*parseInt(n,10)/3);if(n.indexOf("%")>0)return Math.floor(e*parseInt(n,10)/100);var r=parseInt(n,10);return isNaN(r)?0:r},mapBoxSize:function(t,e,n){var i="string"==typeof t?t:t+"";if(i.indexOf("%")>0){var r=Math.floor(n*parseInt(i,10)/100);return Math.min(n,r)}return this.mapFontSize(t,e)},parseEdgeSize:function(t,e,n){if(t instanceof Array)return u.map(t,function(t){return l.mapBoxSize(t,e,n)});if("object"==typeof t){var i={},r=arguments.callee;for(var s in t)i[s]=r(t[s],e,n);return i}return l.mapBoxSize(t,e,n)}},c={trimHeadCRLF:function(t){return t.replace(/^\n+/,"")},trimFootCRLF:function(t){return t.replace(/\n+$/,"")},trimCRLF:function(t){return this.trimFootCRLF(this.trimHeadCRLF(t))},trim:function(t){return t.replace(/^\s+/,"").replace(/\s+$/,"")},capitalize:function(t){return""===t?"":t.charAt(0).toUpperCase()+t.slice(1)},log:function(t,e){var n=e||10;return Math.log(t)/Math.log(n)},filenameConcat:function(t,e){return t=""===t?"":"/"===t.slice(-1)?t:t+"/",e=""===e?"":"/"===e[0]?e.substring(1,e.length):e,t+e},getCamelName:function(t){var e=this;return u.mapi(t.split("-"),function(t,n){return 0===t?n:e.capitalize(n)}).join("")}},f={cssVenderPrefixes:["-moz","-webkit","-o","-ms"],cssCorders:["top-left","top-right","bottom-left","bottom-right"],cssBorderRadius:["border-top-left-radius","border-top-right-radius","border-bottom-left-radius","border-bottom-right-radius"],cssBoxDirs:["top","right","bottom","left"],boxEdgeNames:["padding","margin","border"],space:"&nbsp;",clearFix:"<div style='clear:both'></div>"},g={attr:function(t){var e=[];for(var n in t)e.push(n+":"+d.escape(t[n]+""));return e.join(";")},addNehanPrefix:function(t){return"nehan-"+t},addNehanHeaderPrefix:function(t){return"nehan-header-"+t},addNehanTocLinkPrefix:function(t){return"nehan-toc-link-"+t},toVenderizedList:function(t){var e=u.map(f.cssVenderPrefixes,function(e){return[e,t].join("-")});return e.push(t),e},toClassProp:function(t){var e=t.split("-");return e[0]+u.fold(e.slice(1),"",function(t,e){return t+c.capitalize(e)})},sortCorner:function(t,e){var n={top:0,bottom:1,left:2,right:3};return[t,e].sort(function(t,e){return n[t]-n[e]})}},d={escape:function(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;")},attr:function(t){var e=[];for(var n in t)t[n]&&e.push(n+"='"+this.escape(t[n]+"")+"'");return e==[]?"":e.join(" ")},tagWrap:function(t,e,n){return[this.tagStart(t,n||{}),e,this.tagEnd(t)].join("")},tagSingle:function(t,e){return"<"+t+" "+this.attr(e)+"/>"},tagStart:function(t,e){return"<"+t+" "+this.attr(e)+">"},tagEnd:function(t){return"</"+t+">"}},p={id:function(){return function(t){return t}},eq:function(t){return function(e){return t==e}},neq:function(t){return function(e){return t!=e}}},m={copy:function(t,e){for(var n in e)t[n]=e[n];return t},update:function(t,e){for(var n in e)t[n]=e[n];return t},merge:function(t,e,n){for(var i in e)t[i]=n[i]===void 0?e[i]:n[i];return t}},k=function(){return{PAGE_BREAK:2,LINE_BREAK:3,BUFFER_END:4,OVER_FLOW:5,RETRY:6,SKIP:7,BREAK:8}}(),b=function(){function t(t,e){this._type="tag",this._inherited=!1,this.src=this._preprocess(t),this.name=this._parseName(this.src),this.tagAttr={},this.cssAttrStatic={},this.cssAttrDynamic={},this.dataset={},this.tagAttr=this._parseTagAttr(this.src),this.classes=this._parseClasses(),this.cssKeys=this._parseCssKeys(this.classes),this.cssAttrStatic=this._parseCssAttrStatic(this.cssKeys),this.parent=null,this.content=this._parseContent(e||"")}var e=/(?:\S+)=["']?(?:(?:.(?!["']?\s+(?:\S+)=|["']))+.)["']?/g,n=/(^(<[^>]+>|[\s\n])*)(\S)/im,r=function(t,e){var n=s[t]||null;return n?n[e]||!1:!1},a=function(t){return r(t,"single")},o=function(t){return r(t,"child-content")},f=function(t){return r(t,"section")},g=function(t){return r(t,"section-root")};return t.prototype={inherit:function(t){if(!this._inherited){var e=this;this.parent=t,this.iterCssAttr(function(n,i){"inherit"===i&&e.setCssAttr(n,t.getAttr(n))}),"body"!=t.getName()&&(this.cssKeys=this._getContextualCssKeys(this.cssKeys,t),u.iter(this.cssKeys,function(t){m.copy(e.cssAttrStatic,s[t]||{})})),this._inherited=!0}},copyPseudoStyle:function(t,e){var n=this._parsePseudoStyle(t);for(var i in n)"content"!==i&&e.setCssAttr(i,n[i]);return e},setContent:function(t){this.content=this._parseContent(t)},setTagAttr:function(t,e){this.tagAttr[t]=e},setCssAttr:function(t,e){this.cssAttrDynamic[t]=e},setFirstChild:function(){var t=this._parsePseudoStyle("first-child");m.update(this.cssAttrStatic,t)},setFontSizeUpdate:function(t){this.fontSize=t},setFontColorUpdate:function(t){this.fontColor=t},addClass:function(t){this.classes.push(t)},removeClass:function(t){this.classes=u.filter(this.classes,function(e){return e!=t})},iterTagAttr:function(t){u.each(this.tagAttr,t)},iterCssAttrDynamic:function(t){u.each(this.cssAttrDynamic,t)},iterCssAttrStatic:function(t){u.each(this.cssAttrStatic,t)},iterCssAttr:function(t){this.iterCssAttrStatic(t),this.iterCssAttrDynamic(t)},iterAttr:function(t){this.iterCssAttr(t),this.iterTagAttr(t)},getName:function(){return this.name},getPseudoElementName:function(){return this.isPseudoElementTag()?this.getName().substring(1):""},getAttr:function(t,e){return this.getTagAttr(t)||this.getCssAttr(t)||e||null},getCssKeys:function(){return this.cssKeys},getCssClasses:function(){return this.classes.join(" ")},getTagAttr:function(t,e){return this.tagAttr[t]||e||null},getCssAttr:function(t,e){return this.cssAttrDynamic[t]||this.cssAttrStatic[t]||e||null},getDataset:function(t,e){return this.dataset[t]||e||null},getMergedCssAttr:function(){var t={};return this.iterCssAttr(function(e,n){t[e]=n}),t},getOpenTagName:function(){var t=this.getName();return this.isClose()?t.slice(1):t},getContent:function(){return this.content},getContentOffset:function(){return""===this.content?0:this.src.length},getCloseOffset:function(){return""===this.content||this.isClose()?0:this.src.length+this.content.length},getCloseTag:function(){return new t(this.getCloseSrc())},getCloseSrc:function(){return this.isClose()?this.src:"</"+this.getName()+">"},getSrc:function(){return this.src},getWrapSrc:function(){return this.src+this.content+this.getCloseSrc()},getBlockAlign:function(){return this.getCssAttr("block-align","none")},getHeaderRank:function(){return this.getName().match(/h([1-6])/)?parseInt(RegExp.$1,10):0},getStaticSize:function(t,e){var n=this.getAttr("width"),r=this.getAttr("height");if(n&&r)return n=l.mapBoxSize(n,t,e),r=l.mapBoxSize(r,t,e),new j(n,r);if("img"===this.name){var s=i.fontSize;return new j(s,s)}return null},hasStaticSize:function(){return null!==this.getAttr("width")&&null!==this.getAttr("height")},hasFlow:function(){return null!==this.getCssAttr("flow")},hasClass:function(t){return u.exists(this.classes,p.eq(t))},isSameAs:function(t){return this.alias?this.alias==t:this.name==t},isClassAttrEnable:function(){return this.tagAttr["class"]!==void 0},isBlockAligned:function(){return"none"!=this.getBlockAlign()},isPush:function(){return this.tagAttr.push!==void 0},isPull:function(){return this.tagAttr.pull!==void 0},isOpen:function(){return a()?!1:"/"!==this.name.substring(0,1)},isClose:function(){return"/"===this.name.substring(0,1)},isAnchorTag:function(){return"a"===this.name&&null!==this.getTagAttr("name")},isAnchorLinkTag:function(){var t=this.getTagAttr("href");return"a"===this.name&&t&&t.indexOf("#")>=0},isPseudoElementTag:function(){return":"===this.getName().charAt(0)},isEmphaTag:function(){return null!==this.getCssAttr("empha-mark")},isEmbeddableTag:function(){return this.getCssAttr("embeddable")===!0},isBlock:function(){return this.isBlockAligned()||this.isPush()||this.isPull()?!0:"block"===this.getCssAttr("display","inline")},isInline:function(){return"inline"===this.getCssAttr("display","inline")},isInlineBlock:function(){return"inline-block"===this.getCssAttr("display","inline")},isSingleTag:function(){return a(this.getName())},isChildContentTag:function(){return this.isSingleTag()?!1:o(this.getName())},isTcyTag:function(){return"horizontal"===this.getCssAttr("text-combine","")},isSectionRootTag:function(){return g(this.getName())},isSectionTag:function(){return f(this.getName())},isBoldTag:function(){var t=this.getName();return"b"===t||"strong"===t},isHeaderTag:function(){return this.getHeaderRank()>0},isPageBreakTag:function(){var t=this.getName();return"end-page"===t||"page-break"===t},_getContextualCssKeys:function(t,e){return u.fold(e.getCssKeys(),[],function(e,n){return e.concat(u.fold(t,[],function(t,e){return t.concat([n+" "+e])}))}).concat(t)},_preprocess:function(t){return t.replace(/\s*=\s*/g,"=")},_parseName:function(t){return t.replace(/</g,"").replace(/\/?>/g,"").split(/\s/)[0]},_parseClasses:function(){var t=this.tagAttr["class"]||"";return""===t?[]:t.split(/\s+/)},_parseCssClasses:function(t){return u.map(t,function(t){return"."+t})},_parseCssClassesWithTag:function(t,e){return u.map(e,function(e){return t+"."+e})},_parseCssClassesAll:function(t,e){var n=this._parseCssClasses(e);return n.concat(this._parseCssClassesWithTag(t,e))},_parseCssKeys:function(t){var e=this.getName();return[e].concat(this._parseCssClassesAll(e,t))},_parseCssAttrStatic:function(t){var e={};return u.iter(t,function(t){m.copy(e,s[t]||{})}),e},_parsePseudoCssKeys:function(t){return u.map(this.cssKeys,function(e){return e+":"+t})},_parsePseudoStyle:function(t){var e={},n=this._parsePseudoCssKeys(t);return u.iter(n,function(t){m.copy(e,s[t]||{})}),e},_parsePseudoContent:function(t){var e=this._parsePseudoStyle(t),n=e.content||"";return""===n?"":d.tagWrap(":"+t,d.escape(n))},_parsePseudoFirstContent:function(t){var e=this._parsePseudoStyle("first-letter"),i=this._parsePseudoStyle("first-line"),r=!h.isEmpty(e),s=!h.isEmpty(i);if(!r&&!s)return t;var a=[],o=[];return s&&a.push("<:first-line>"),r&&(a.push("<:first-letter>"),o.push("</:first-letter>")),t.replace(n,function(t,e,n,i){return e+a.join("")+i+o.join("")})},_parseContent:function(t){var e=this._parsePseudoContent("before"),n=this._parsePseudoContent("after");return t=this._parsePseudoFirstContent(t),e+t+n},_parseTagAttr:function(t){var e=this._parseTagAttrNv(t);return u.iter(this._parseTagAttrSingle(t),function(t){e[t]=!0}),e},_parseTagAttrNv:function(t){var n={},i=this,r=t.match(e);return null===r?n:(u.iter(r,function(t){var e=t.split("=");if(e.length>=2){var r=e[0],s=e[1];s=s.replace(/['"]/g,""),i._parseTagAttrNvValue(n,r,s)}}),n)},_parseTagAttrNvValue:function(t,e,n){if("style"===e){var i=this._parseTagAttrInlineStyle(n);m.copy(this.cssAttrDynamic,i)}else if(0===e.indexOf("data-")){var r=this._parseDatasetName(e);this.dataset[r]=n}else t[e]=n},_parseTagAttrInlineStyle:function(t){var e={},n=t.indexOf(";")>=0?t.split(";"):[t];return u.iter(n,function(t){var n=t.split(":");if(n.length>=2){var i=c.trim(n[0]),r=c.trim(n[1]);e[i]=r}}),e},_parseDatasetName:function(t){var e=t.slice(5);return c.getCamelName(e)},_parseTagAttrSingle:function(t){var e=t.replace(/<\S+/g,"").replace(/\/?>/g,"").split(/\s+/);return u.filter(e,function(t){return""!==t&&0>t.indexOf("=")})}},t}(),x={isTag:function(t){return"tag"===t._type},isText:function(t){return"char"===t._type||"word"===t._type||"tcy"===t._type},isChar:function(t){return"char"===t._type},isWord:function(t){return"word"===t._type},isTcy:function(t){return"tcy"===t._type},isInline:function(t){return this.isText(t)?!0:t.isBlock()?!1:t.isInline()||t.isInlineBlock()}},y=function(){function t(t,e){this.data=t,this._type="char",this.isRef=e||!1,this.isRef||this._setup(t.charCodeAt(0))}var e=["。","."],n=["、",","],r=["｢","「","『","【","［","（","《","〈","≪","＜","｛","{","[","("],s=["」","｣","』","】","］","）","》","〉","≫","＞","｝","}","]",")"],a=["ぁ","ぃ","ぅ","ぇ","ぉ","っ","ゃ","ゅ","ょ","ゎ","ァ","ィ","ゥ","ェ","ォ","ヵ","ヶ","ッ","ャ","ュ","ョ","ヮ"],o=["）","\\",")","」","】","〕","］","\\","]","。","』","＞","〉","》","、","．","\\",".",",","”","〟"],h=["（","\\","(","「","【","［","〔","\\","[","『","＜","〈","《","“","〝"];return t.prototype={getCssPadding:function(t){var e=new V;return this.paddingStart&&e.setStart(t,this.paddingStart),this.paddingEnd&&e.setEnd(t,this.paddingEnd),e.getCss()},getHoriScale:function(){return this.hscale?this.hscale:1},getVertScale:function(){return this.vscale?this.vscale:1},isPaddingEnable:function(){return this.paddingStart!==void 0||this.paddingEnd!==void 0},hasMetrics:function(){return this.bodySize!==void 0&&this.fontSize!==void 0},getAdvance:function(t,e){return this.bodySize+this.getPaddingSize()+e},getPaddingSize:function(){return(this.paddingStart||0)+(this.paddingEnd||0)},getCharCount:function(){return" "===this.data||"	"===this.data||"　"===this.data?0:1},setMetrics:function(t,e){var n=t.isTextVertical(),i=n?this.getVertScale():this.getHoriScale();this.fontSize=e,this.bodySize=1!=i?Math.floor(e*i):e,this.spaceRateStart&&(this.paddingStart=Math.floor(this.spaceRateStart*e)),this.spaceRateEnd&&(this.paddingEnd=Math.floor(this.spaceRateEnd*e)),this.img&&"tenten"===this.img&&(this.bodySize=e),n||this.isRef||!this.isHankaku()||(this.bodySize=Math.floor(e/2))},_setImg:function(t,e,n){this.img=t,this.vscale=e||1,this.hscale=n||this.vscale},_setCnv:function(t,e,n){this.cnv=t,this.vscale=e||1,this.hscale=n||this.vscale},_setup:function(t){switch(t){case 32:this._setCnv("&nbsp;",.5,.5);break;case 12300:this._setImg("kakko1",.5);break;case 65378:this._setImg("kakko1",.5);break;case 12301:this._setImg("kakko2",.5);break;case 65379:this._setImg("kakko2",.5);break;case 12302:this._setImg("kakko3",.5);break;case 12303:this._setImg("kakko4",.5);break;case 65288:this._setImg("kakko5",.5);break;case 40:this._setImg("kakko5",.5);break;case 65371:this._setImg("kakko5",.5);break;case 123:this._setImg("kakko5",.5);break;case 65289:this._setImg("kakko6",.5);break;case 41:this._setImg("kakko6",.5);break;case 65373:this._setImg("kakko6",.5);break;case 125:this._setImg("kakko6",.5);break;case 65308:this._setImg("kakko7",.5);break;case 60:this._setImg("kakko7",.5);break;case 12296:this._setImg("kakko7",.5);break;case 65310:this._setImg("kakko8",.5);break;case 62:this._setImg("kakko8",.5);break;case 12297:this._setImg("kakko8",.5);break;case 12298:this._setImg("kakko9",.5);break;case 8810:this._setImg("kakko9",.5);break;case 12299:this._setImg("kakko10",.5);break;case 8811:this._setImg("kakko10",.5);break;case 65339:this._setImg("kakko11",.5);break;case 12308:this._setImg("kakko11",.5);break;case 91:this._setImg("kakko11",.5);break;case 65341:this._setImg("kakko12",.5);break;case 12309:this._setImg("kakko12",.5);break;case 93:this._setImg("kakko12",.5);break;case 12304:this._setImg("kakko17",.5);break;case 12305:this._setImg("kakko18",.5);break;case 65306:this._setImg("tenten",.5,1);break;case 58:this._setImg("tenten",.5,1);break;case 12290:this._setImg("kuten",.5);break;case 65377:this._setImg("kuten",.5);break;case 65294:this._setImg("period",1);break;case 46:this._setImg("period",1);break;case 12289:this._setImg("touten",.5);break;case 65380:this._setImg("touten",.5);break;case 44:this._setImg("touten",.5);break;case 65292:this._setImg("touten",.5);break;case 65374:this._setImg("kara",1);break;case 12316:this._setImg("kara",1);break;case 8230:this._setImg("mmm",1);break;case 8229:this._setImg("mm",1);break;case 12317:this._setImg("dmn1",1);break;case 12319:this._setImg("dmn2",1);break;case 65309:this._setImg("equal",1);break;case 61:this._setImg("equal",1);break;case 12540:this._setImg("onbiki",1);break;case 45:this._setCnv("&#65372;");break;case 8213:this._setCnv("&#65372;");break;case 65293:this._setCnv("&#65372;");break;case 9472:this._setCnv("&#65372;");break;case 8593:this._setCnv("&#8594;");break;case 8594:this._setCnv("&#8595;");break;case 8658:this._setCnv("&#8595;");break;case 8595:this._setCnv("&#8592;");break;case 8592:this._setCnv("&#8593;")}},isNewLineChar:function(){return"\n"===this.data},isImgChar:function(){return this.img!==void 0},isCnvChar:function(){return this.cnv!==void 0},isCharRef:function(){return this.isRef},isHalfSpaceChar:function(){return this.isCnvChar()&&"&nbsp;"===this.cnv},isKerningChar:function(){return this.isKutenTouten()||this.isKakko()},getImgSrc:function(t){return[i.fontImgRoot,this.img,t+".png"].join("/")},isTenten:function(){return this.img&&"tenten"===this.img},isHeadNg:function(){return u.mem(o,this.data)},isTailNg:function(){return u.mem(h,this.data)},isSmallKana:function(){return u.mem(a,this.data)},isKakkoStart:function(){return u.mem(r,this.data)},isKakkoEnd:function(){return u.mem(s,this.data)},isKakko:function(){return this.isKakkoStart()||this.isKakkoEnd()},isKuten:function(){return u.mem(e,this.data)},isTouten:function(){return u.mem(n,this.data)},isKutenTouten:function(){return this.isKuten()||this.isTouten()},isZenkaku:function(){return"u"===escape(this.data).charAt(1)},isHankaku:function(){return!this.isZenkaku(this.data)}},t}(),v=function(){function t(t,e){this.data=t,this._type="word",this._part=e||!1}return t.prototype={getCharCount:function(){return 1},getAdvance:function(t,e){return this.bodySize+e*this.getLetterCount()},hasMetrics:function(){return this.bodySize!==void 0&&this.fontSize!==void 0},setMetrics:function(t,e,n){if(this.fontSize=e,this.bodySize=this.data.length*Math.floor(e/2),n){var r=i.boldRate;this.bodySize+=Math.floor(r*this.bodySize)}},getLetterCount:function(){return this.data.length},isPartWord:function(){return this._part},cutMeasure:function(e){var n=Math.floor(this.fontSize/2),i=Math.floor(this.bodySize/n),r=Math.floor(e/n);if(r>=i)return this;var s=this.data.substring(0,r),a=new t(s,!0);return this.data=this.data.slice(r),a}},t}(),S=function(){function t(t){this.data=t,this._type="tcy"}return t.prototype={getCharCount:function(){return 1},getAdvance:function(t,e){return this.bodySize+e},hasMetrics:function(){return this.bodySize!==void 0&&this.fontSize!==void 0},setMetrics:function(t,e){this.fontSize=e,this.bodySize=e}},t}(),C=function(){function t(t,e){this._type="ruby",this.rbs=t,this.rt=e}return t.prototype={hasMetrics:function(){return this.advanceSize!==void 0},getAdvance:function(){return this.advanceSize},getExtent:function(){return this.baseFontSize
},getFontSize:function(){return this.baseFontSize},getRbs:function(){return this.rbs},getRtFontSize:function(){return this.rubyFontSize},getRtString:function(){return this.rt?this.rt.content:""},getCss:function(t){var e={};return e.position="absolute",e["font-size"]=this.rubyFontSize+"px",e[t.getPropStart()]=this.startPos+"px",e[t.getTextSide()]=this._getBaseLineOffset(t)+"px",e},setStartPos:function(t){this.startPos=t},setMetrics:function(t,e,n){this.baseFontSize=e,this.rubyFontSize=Math.floor(e*i.rubyRate);var r=u.fold(this.rbs,0,function(i,r){return r.setMetrics(t,e),i+r.getAdvance(t,n)}),s=this.rubyFontSize*this.getRtString().length;if(this.advanceSize=r,s>r){var a=Math.ceil((s-r)/2);this.rbs.length>0&&(this.rbs[0].paddingStart=a,this.rbs[this.rbs.length-1].paddingEnd=a),this.advanceSize+=a+a}},_getBaseLineOffset:function(t){return t.isTextVertical()?this._getBaseLineOffsetVert(t):this._getBaseLineOffsetHori(t)},_getBaseLineOffsetVert:function(t){var e=t.getBodyLineContentExtent()-this.baseFontSize,n=1+t.lineRate,r=Math.floor(n*i.rubyRate*e/2);return r>0?-r:0},_getBaseLineOffsetHori:function(t){var e=t.getContentExtent(),n=e-this.rubyFontSize;return-Math.floor(n/2)}},t}(),_=function(){function t(t){this.data=t.data||"&#x2022",this.startPos=t.startPos||0,this.parent=t.parent,this.fontSize=this.parent.fontSize}return t.prototype={getCss:function(t){var e={};return e.position="absolute",e[t.getPropStart()]=this.startPos+"px",e},getAdvance:function(t){return this.parent.getAdvance(t)}},t}(),w=function(){function t(t){this.value=t+"";var i=parseInt(this.value.substring(0,2),16),r=parseInt(this.value.substring(2,4),16),s=parseInt(this.value.substring(4,6),16),a=this._findPalette(i,e),o=this._findPalette(r,e),u=this._findPalette(s,n);this.paletteValue=[this._makeHexStr(a),this._makeHexStr(o),this._makeHexStr(u)].join("")}var e=[0,36,73,109,146,182,219,255],n=[0,85,170,255];return t.prototype={getColorValue:function(){return this.value},getPaletteValue:function(){return this.paletteValue},getPaletteValueLower:function(){return this.paletteValue.toLowerCase()},getPaletteValueUpper:function(){return this.paletteValue.toUpperCase()},_makeHexStr:function(t){var e=t.toString(16);return 1>=e.length?"0"+e:e},_findPalette:function(t,e){return u.exists(e,p.eq(t))?t:u.minobj(e,function(e){return Math.abs(e-t)})}},t}(),T=function(){function t(t){this.value=this._parseColorValue(t),this.rgb=new w(this.value)}var e={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4","indianred ":"cd5c5c","indigo ":"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};return t.prototype={getValue:function(){return this.value},getValueLower:function(){return this.value.toLowerCase()},getValueUpper:function(){return this.value.toUpperCase()},getPaletteValue:function(){return this.rgb.getPaletteValue()},getPaletteValueLower:function(){return this.rgb.getPaletteValueLower()},getPaletteValueUpper:function(){return this.rgb.getPaletteValueUpper()},getCssValue:function(){return"#"+this.value},_parseColorValue:function(t){var e=t.replace("#","");return this._checkValidColor(e)?3===e.length&&(e=this._regulateColor(e)):e=this._getColorByName(e),e},_checkValidColor:function(t){return/^(?:[0-9a-fA-F]{3}){1,2}$/.test(t)},_getColorByName:function(t){return e[t]},_regulateColor:function(t){return t[0]+t[0]+t[1]+t[1]+t[2]+t[2]}},t}(),B=function(){function t(t,e){this.table=t,this._isZenkaku=e}return t.prototype={isZenkaku:function(){return this._isZenkaku},getBase:function(){return this.table.length},getChar:function(t){return this.table[t]||""},getTable:function(){return this.table}},t}(),E=function(){var t={"lower-alpha":new B(["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],!1),"upper-alpha":new B(["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],!1),"lower-roman":new B(["i","ii","iii","iv","v","vi","vii","viii","ix","x","xi","xii","xiii","xiv","xv","xvi","xvii","xviii","xix","xx"],!1),"upper-roman":new B(["I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX"],!1),"lower-greek":new B(["α","β","γ","δ","ε","ζ","η","θ","ι","κ","λ","μ","ν","ξ","ο","π","ρ","σ","τ","υ","φ","χ","ψ","ω"],!0),"upper-greek":new B(["Α","Β","Γ","Δ","Ε","Ζ","Η","Θ","Ι","Κ","Λ","Μ","Ν","Ξ","Ο","Π","Ρ","Σ","Τ","Υ","Φ","Χ","Ψ","Ω"],!0),"cjk-ideographic":new B(["一","二","三","四","五","六","七","八","九","十"],!0),hiragana:new B(["あ","い","う","え","お","か","き","く","け","こ","さ","し","す","せ","そ","た","ち","つ","て","と","な","に","ぬ","ね","の","は","ひ","ふ","へ","ほ","ま","み","む","め","も","や","ゆ","よ","ら","り","る","れ","ろ","わ","ゐ","ゑ","を","ん"],!0),"hiragana-iroha":new B(["い","ろ","は","に","ほ","へ","と","ち","り","ぬ","る","を","わ","か","よ","た","れ","そ","つ","ね","な","ら","む","う","ゐ","の","お","く","や","ま","け","ふ","こ","え","て","あ","さ","き","ゆ","め","み","し","ゑ","ひ","も","せ","す"],!0),katakana:new B(["ア","イ","ウ","エ","オ","カ","キ","ク","ケ","コ","サ","シ","ス","セ","ソ","タ","チ","ツ","テ","ト","ナ","ニ","ヌ","ネ","ノ","ハ","ヒ","フ","ヘ","ホ","マ","ミ","ム","メ","モ","ヤ","ユ","ヨ","ラ","リ","ル","レ","ロ","ワ","ヰ","ヱ","ヲ","ン"],!0),"katakana-iroha":new B(["イ","ロ","ハ","ニ","ホ","ヘ","ト","チ","リ","ヌ","ル","ヲ","ワ","カ","ヨ","タ","レ","ソ","ツ","ネ","ナ","ラ","ム","ウ","ヰ","ノ","オ","ク","ヤ","マ","ケ","フ","コ","エ","テ","ア","サ","キ","ユ","メ","ミ","シ","ヱ","ヒ","モ","セ","ス"],!0)},e={"upper-latin":"upper-alpha","lower-latin":"lower-alpha"};return{get:function(n){return t[e[n]||n]}}}(),z=function(){function t(t){this.cardinalString=t}var e=function(t,e){t.toString(10);for(var n=[],i=t;i>0;)n.push(i%e),i=Math.floor(i/e);return n.length>0?n:[0]};return t.prototype={isZenkaku:function(){return this.cardinalString.isZenkaku()},getBase:function(){return this.cardinalString.getBase()},getChar:function(t){return this.cardinalString.getChar(t)},getString:function(t){for(var n=e(t,this.getBase()),i="",r=n.length-1;r>=0;r--){var s=n[r],a=r==n.length-1&&r>0?s-1:s;i+=this.getChar(a)}return i}},t}(),P=function(){function t(t){this.type=t.type||"none",this.position=t.position||"outside",this.imageURL=t.imageURL||"none",this.counter=this._getCounter()}return t.prototype={isInside:function(){return"inside"===this.position},isImageList:function(){return"none"!==this.imageURL},isSimpleDecimalList:function(){return"decimal"===this.type},isArithmeticDecimalList:function(){return"decimal-leading-zero"===this.type},isDecimalList:function(){return this.isSimpleDecimalList()||this.isArithmeticDecimalList()},isUnitList:function(){return"none"===this.type},getMarkerAdvance:function(t,e){var n=Math.floor(t/2),r=n,s=i.getListMarkerSpacingSize(t),a=n,o="";return this.isInside()?t+s:this.isImageList()?i.fontSize:this.isDecimalList()?(o=this._getMarkerText(e-1),o.length*a+r+s):this.counter?(a=this.counter.isZenkaku()?t:n,o=this._getMarkerText(e-1),o.length*a+r+s):t+s},getMarker:function(t){var e=this._getMarkerBody(t);return this.isInside()?d.tagWrap("span",e,{"class":"nehan-inside-marker"}):e},_getMarkerBody:function(t){if(this.isImageList())return this._getImageMarker();if(this.isDecimalList())return this._getMarkerText(t)+".";if(this.counter){var e=this._getMarkerText(t)+".";return this.counter.isZenkaku()?d.tagWrap("span",e,{"class":"nehan-tcy"}):e}return this._getMarkerText(t)},_getMarkerText:function(t){return this.isUnitList()?f.space:this.isSimpleDecimalList()?(t+1).toString(10):this.isArithmeticDecimalList()?10>t+1?"0"+(t+1).toString(10):(t+1).toString(10):this.counter?this._getCounterMarker(t):this._getSingleMarker()},_getCounter:function(){var t=E.get(this.type);return t?new z(t):null},_getCounterMarker:function(t){return this.counter.getString(t)},_getSingleMarker:function(){switch(this.type){case"disc":return"&#x2022;";case"circle":return"&#x25CB;";case"square":return"&#x25A0;"}return""},_getImageMarker:function(){var t=i.fontSize;return d.tagSingle("img",{src:this.imageURL,width:t,height:t})}},t}(),A=o.extend({init:function(t){this.dir=t},isValid:function(){return"lr"===this.dir||"rl"===this.dir||"tb"===this.dir},isHorizontal:function(){return"lr"===this.dir||"rl"===this.dir},isVertical:function(){return"tb"===this.dir},isLeftToRight:function(){return"lr"===this.dir},isRightToLeft:function(){return"rl"===this.dir},reverse:function(){switch(this.dir){case"lr":return"rl";case"rl":return"lr";case"tb":return"tb";default:return""}}}),R=A.extend({init:function(t,e){this._super(t),this.multicol=e||!1},flip:function(){switch(this.dir){case"lr":case"rl":return"tb";case"tb":return i.getVertBlockdir();default:return""}},getCss:function(){var t={};return this.isHorizontal()?t["float"]="lr"===this.dir?"left":"right":this.isVertical()&&this.multicol&&(t["float"]="lr"===i.getHoriIndir()?"left":"right"),t},getPropBefore:function(){switch(this.dir){case"lr":return"left";case"rl":return"right";case"tb":return"top";default:return""}},getPropAfter:function(){switch(this.dir){case"lr":return"right";case"rl":return"left";case"tb":return"bottom";default:return""}}}),L=A.extend({init:function(t){this._super(t)},getPropStart:function(){switch(this.dir){case"lr":return"left";case"rl":return"right";case"tb":return"top";default:return""}},getPropEnd:function(){switch(this.dir){case"lr":return"right";case"rl":return"left";case"tb":return"bottom";default:return""}}}),I=function(){function t(t,e,n){this.inflow=new L(t),this.blockflow=new R(e,n)}return t.prototype={getCss:function(){var t={};return m.copy(t,this.blockflow.getCss()),t},getName:function(){return[this.inflow.dir,this.blockflow.dir].join("-")},isValid:function(){return this.inflow.isValid()&&this.blockflow.isValid()},isTextLineFirst:function(){return!this.isRubyLineFirst()},isRubyLineFirst:function(){return this.inflow.isVertical()&&this.blockflow.isLeftToRight()?!1:!0},isBlockflowVertical:function(){return this.blockflow.isVertical()},isTextVertical:function(){return this.inflow.isVertical()},isTextHorizontal:function(){return this.inflow.isHorizontal()},getTextHorizontalDir:function(){return this.isTextHorizontal()?this.inflow.dir:""},getProp:function(t){switch(t){case"start":return this.getPropStart();case"end":return this.getPropEnd();case"before":return this.getPropBefore();case"after":return this.getPropAfter()}},getTextSide:function(){return this.isTextLineFirst()?this.blockflow.getPropBefore():this.blockflow.getPropAfter()},getPropStart:function(){return this.inflow.getPropStart()},getPropEnd:function(){return this.inflow.getPropEnd()},getPropBefore:function(){return this.blockflow.getPropBefore()},getPropAfter:function(){return this.blockflow.getPropAfter()},getPropExtent:function(){return this.isTextVertical()?"width":"height"},getPropMeasure:function(){return this.isTextVertical()?"height":"width"},getPropWidth:function(){return this.isTextVertical()?"extent":"measure"},getPropHeight:function(){return this.isTextVertical()?"measure":"extent"},getParallelFlipFlow:function(){return N.get(this.inflow.dir,this.blockflow.dir,!1)},getParallelFlow:function(){return N.get(this.inflow.dir,this.blockflow.dir,!0)},getFlipFlow:function(){return this.isTextVertical()?i.getStdHoriFlow():i.getStdVertFlow()},getAlignedWrapFlow:function(){return this.isTextVertical()?this:this.getParallelFlow()},getBoxSize:function(t,e){var n=new j(0,0);return n[this.getPropMeasure()]=t,n[this.getPropExtent()]=e,n}},t}(),N={"tb-rl":new I("tb","rl"),"tb-lr":new I("tb","lr"),"lr-tb":new I("lr","tb"),"rl-tb":new I("rl","tb"),"tb-rl-mc":new I("tb","rl",!0),"tb-lr-mc":new I("tb","lr",!0),"lr-tb-mc":new I("lr","tb",!0),"rl-tb-mc":new I("rl","tb",!0),NORMAL:new I("lr","tb"),get:function(t,e,n){var i=n||!1,r=t+"-"+e+(i?"-mc":"");return this.getByName(r)},getByName:function(t){return this[t]}},M=o.extend({init:function(t){this._type=t,this.top=0,this.right=0,this.bottom=0,this.left=0},clear:function(){this.top=0,this.right=0,this.bottom=0,this.left=0},isEnable:function(){return 0!==this.top||0!==this.right||0!==this.bottom||0!==this.left},getDirProp:function(t){return[this._type,t].join("-")},getCss:function(){var t={},e=this;return u.iter(["top","right","bottom","left"],function(n){var i=e[n];i>0&&(t[e.getDirProp(n)]=e[n]+"px")}),t},getWidth:function(){return this.left+this.right},getHeight:function(){return this.top+this.bottom},getMeasureSize:function(t){return t.isTextVertical()?this.getHeight():this.getWidth()},getExtentSize:function(t){return t.isBlockflowVertical()?this.getHeight():this.getWidth()},setSize:function(t,e){e instanceof Array?this.setSizeByArray(t,e):"object"==typeof e?this.setSizeByObj(t,e):this.setAll(t,e)},setSizeByObj:function(t,e){e.start!==void 0&&this.setStart(t,e.start),e.end!==void 0&&this.setEnd(t,e.end),e.before!==void 0&&this.setBefore(t,e.before),e.after!==void 0&&this.setAfter(t,e.after)},setSizeByArray:function(t,e){switch(e.length){case 1:this.setAll(t,e[0]);break;case 2:this.setBefore(t,e[0]),this.setAfter(t,e[0]),this.setStart(t,e[1]),this.setEnd(t,e[1]);break;case 3:this.setBefore(t,e[0]),this.setEnd(t,e[1]),this.setStart(t,e[1]),this.setAfter(t,e[2]);break;case 4:this.setBefore(t,e[0]),this.setEnd(t,e[1]),this.setAfter(t,e[2]),this.setStart(t,e[3])}},setAll:function(t,e){this.setSize(t,{start:e,end:e,before:e,after:e})},setStart:function(t,e){this[t.getPropStart()]=e},setEnd:function(t,e){this[t.getPropEnd()]=e},setBefore:function(t,e){this[t.getPropBefore()]=e},setAfter:function(t,e){this[t.getPropAfter()]=e},getStart:function(t){return this[t.getPropStart()]},getEnd:function(t){return this[t.getPropEnd()]},getBefore:function(t){return this[t.getPropBefore()]},getAfter:function(t){return this[t.getPropAfter()]},getLogicalSize:function(t,e){return this[t.getProp(e)]},setLogicalSize:function(t,e,n){this[t.getProp(e)]=n}}),F=function(){function t(){this.hori=0,this.vert=0}return t.prototype={setSize:function(){if(1==arguments.length){var t=arguments[0];t instanceof Array?this.setSizeByArray(t):"object"==typeof t?this.setSizeByObj(t):this.hori=this.vert=t}else 2===arguments.length?(this.hori=arguments[0],this.vert=arguments[1]):this.hori=this.vert=0},setSizeByObj:function(t){t.hori!==void 0&&(this.hori=t.hori),t.vert!==void 0&&(this.vert=t.vert)},setSizeByArray:function(t){switch(t.length){case 1:this.hori=this.vert=t[0];break;case 2:this.hori=t[0],this.vert=t[1]}},getCssValue:function(){return this.hori==this.vert?this.hori+"px":[this.hori+"px",this.vert+"px"].join(" ")},isEnable:function(){return this.hori>0||this.vert>0}},t}(),H=function(){function t(){this.borderTopLeftRadius=new F,this.borderTopRightRadius=new F,this.borderBottomLeftRadius=new F,this.borderBottomRightRadius=new F}return t.prototype={getCss:function(){var t=this,e={};return u.iter(f.cssBorderRadius,function(n){var i=t[g.toClassProp(n)];if(i.isEnable()){var r=i.getCssValue();u.iter(g.toVenderizedList(n),function(t){e[t]=r})}}),e},getRadius:function(t,e){var n=g.sortCorner(t,e).join("-"),i=["border",n,"radius"].join("-"),r=g.toClassProp(i);return this[r]},setAll:function(t){this.borderTopLeftRadius.setSize(t),this.borderTopRightRadius.setSize(t),this.borderBottomLeftRadius.setSize(t),this.borderBottomRightRadius.setSize(t)},setSize:function(t,e){e instanceof Array?this.setSizeByArray(t,e):"object"==typeof e?this.setSizeByObj(t,e):this.setAll(e)},setSizeByObj:function(t,e){e["start-before"]!==void 0&&this.setStartBefore(t,e["start-before"]),e["start-after"]!==void 0&&this.setStartAfter(t,e["start-after"]),e["end-before"]!==void 0&&this.setEndBefore(t,e["end-before"]),e["end-after"]!==void 0&&this.setEndAfter(t,e["end-after"])},setSizeByArray:function(t,e){switch(e.length){case 1:this.setAll(e[0]);break;case 2:this.setStartBefore(t,e[0]),this.setEndAfter(t,e[0]),this.setStartAfter(t,e[1]),this.setEndBefore(t,e[1]);break;case 3:this.setStartAfter(t,e[1]),this.setEndBefore(t,e[1]);break;case 4:this.setStartBefore(t,e[0]),this.setEndBefore(t,e[1]),this.setEndAfter(t,e[2]),this.setStartAfter(t,e[3])}},setStartBefore:function(t,e){var n=this.getRadius(t.getPropStart(),t.getPropBefore());n.setSize(e)},setStartAfter:function(t,e){var n=this.getRadius(t.getPropStart(),t.getPropAfter());n.setSize(e)},setEndBefore:function(t,e){var n=this.getRadius(t.getPropEnd(),t.getPropBefore());n.setSize(e)},setEndAfter:function(t,e){var n=this.getRadius(t.getPropEnd(),t.getPropAfter());n.setSize(e)},clearBefore:function(t){this.setStartBefore(t,0),this.setEndBefore(t,0)},clearAfter:function(t){this.setStartAfter(t,0),this.setEndAfter(t,0)}},t}(),V=M.extend({init:function(){this._super("padding")}}),W=M.extend({init:function(){this._super("margin")}}),O=M.extend({init:function(){this._super("border"),this.borderRadius=new H},setRadius:function(t){this.borderRadius.setAll(t)},setRadiusStartBefore:function(t,e,n){this.borderRadius.setStartBefore(t,e,n)},setRadiusStartAfter:function(t,e,n){this.borderRadius.setStartAfter(t,e,n)},setRadiusEndBefore:function(t,e,n){this.borderRadius.setEndBefore(t,e,n)},setRadiusEndAfter:function(t,e,n){this.borderRadius.setEndAfter(t,e,n)},clearBefore:function(t){this.setBefore(t,0),this.borderRadius.clearBefore(t)},clearAfter:function(t){this.setAfter(t,0),this.borderRadius.clearAfter(t)},getDirProp:function(t){return["border",t,"width"].join("-")},setSize:function(t,e){this._super(t,e),e.radius&&this.borderRadius.setSize(t,e.radius)},getCss:function(){var t=this._super();return m.copy(t,this.borderRadius.getCss())}}),G=function(){function t(){this.padding=new V,this.margin=new W,this.border=new O}return t.prototype={isEnable:function(){return this.padding.isEnable()||this.margin.isEnable()||this.border.isEnable()},clear:function(){this.padding.clear(),this.margin.clear(),this.border.clear()},getCss:function(){var t={};return m.copy(t,this.padding.getCss()),m.copy(t,this.margin.getCss()),m.copy(t,this.border.getCss()),t},getWidth:function(){var t=0;return t+=this.padding.getWidth(),t+=this.margin.getWidth(),t+=this.border.getWidth()},getHeight:function(){var t=0;return t+=this.padding.getHeight(),t+=this.margin.getHeight(),t+=this.border.getHeight()},getMeasureSize:function(t){var e=0;return e+=this.padding.getMeasureSize(t),e+=this.margin.getMeasureSize(t),e+=this.border.getMeasureSize(t)},getExtentSize:function(t){var e=0;return e+=this.padding.getExtentSize(t),e+=this.margin.getExtentSize(t),e+=this.border.getExtentSize(t)},setAll:function(t,e,n){this[t].setAll(e,n)},setSize:function(t,e,n){this[t].setSize(e,n)},setEdgeSize:function(t,e){for(var n in e)this.setSize(n,t,e[n])},setEdgeStart:function(t,e,n){this[t].setStart(e,n)},setEdgeEnd:function(t,e,n){this[t].setEnd(e,n)},setEdgeBefore:function(t,e,n){this[t].setBefore(e,n)},setEdgeAfter:function(t,e,n){this[t].setAfter(e,n)},setRadius:function(t){this.border.setRadius(t)},clearBorderStart:function(t){this.border.clearStart(t)},clearBorderBefore:function(t){this.border.clearBefore(t)},clearBorderAfter:function(t){this.border.clearAfter(t)}},t}(),K=function(){function t(t,e){switch(arguments.length){case 1:this.parts=t;break;case 2:this.parts=this._mapSize(t,e)}}return t.prototype={getLength:function(){return this.parts.length},getSize:function(t){return this.parts[t]||null},_mapSize:function(t,e){var n=u.filter(t,function(t){return 0===t}),i=n.length;if(0===i)return t;var r=u.sum(t),s=e-r,a=Math.floor(s/i);return u.map(t,function(t){return t?t:a})}},t}(),D=function(){function t(){this.entry={}}return t.prototype={add:function(t){var e=t.getLength();this.entry[e]=t},getPartition:function(t){return this.entry[t]||null}},t}(),j=function(){function t(t,e){this.width=t,this.height=e}return t.prototype={isValid:function(){return this.width>0&&this.height>0},canInclude:function(t){return t.width<=this.width&&t.height<=this.height},getCss:function(){var t={};return t.width=this.width+"px",t.height=this.height+"px",t},getWhSlope:function(){return this.height/this.width},getHwSlope:function(){return this.width/this.height},getMeasure:function(t){return this[t.getPropMeasure()]},getExtent:function(t){return this[t.getPropExtent()]},setExtent:function(t,e){this[t.getPropExtent()]=e},setMeasure:function(t,e){this[t.getPropMeasure()]=e},subEdge:function(t){var e=t.getWidth(),n=t.getHeight();this.width=Math.max(0,this.width-e),this.height=Math.max(0,this.height-n)},subMeasure:function(t,e){var n=t.getPropMeasure();this[n]=Math.max(0,this[n]-e)},addMeasure:function(t,e){this[t.getPropMeasure()]+=e},addExtent:function(t,e){this[t.getPropExtent()]+=e},percentFrom:function(t){return Math.floor(100*this.width/t.width)},resizeWithin:function(t,e){var n=e.getMeasure(t),i=e.getExtent(t),r=this.getMeasure(t),s=this.getExtent(t);if(s>i&&(r=r*i/s,s=i),r>n){var a=s/r,o=r-n;s=Math.floor(s-a*o),r=n}return t.getBoxSize(r,s)},toLogicalSize:function(t){return new U(this.getMeasure(t),this.getExtent(t))}},t}(),U=function(){function t(t,e){this.measure=t,this.extent=e}return t.prototype={canInclude:function(t){return t.measure<=this.measure&&t.extent<=this.extent},getWidth:function(t){return this[t.getPropWidth()]},getHeight:function(t){return this[t.getPropHeight()]},toBoxSize:function(t){return new j(this.getWidth(t),this.getHeight(t))}},t}(),q=function(){function t(){this.forward=[],this.normal=[],this.backward=[]}return t.prototype={get:function(){return this.forward.concat(this.normal).concat(this.backward)},getLength:function(){return this.forward.length+this.normal.length+this.backward.length},getFirst:function(){return this.forward.length>0?this.forward[0]:this.normal.length>0?this.normal[0]:this.backward.length>0?this.backward[this.backward.length-1]:null},add:function(t){t.backward?this.backward.unshift(t):t.forward?this.forward.push(t):this.normal.push(t)}},t}(),X=function(){function t(t,e,n){this._type=n||"div",this.childExtent=0,this.size=t,this.childs=new q,this.css={},this.parent=e,this.charCount=0}return t.prototype={getCss:function(){var t=this.css;return m.copy(t,this.size.getCss()),this.edge&&m.copy(t,this.edge.getCss()),this.parent&&m.copy(t,this.parent.flow.getCss()),this.fontSize&&(t["font-size"]=this.fontSize+"px"),this.letterSpacing&&!this.isTextVertical()&&(t["letter-spacing"]=this.letterSpacing+"px"),t.display=this.display||"block",t},getCharCount:function(){return this.charCount},getClasses:function(){var t=["nehan-box"];return"box"!=this._type&&t.push(g.addNehanPrefix(this._type)),t.concat(this.extraClasses||[])},getCssClasses:function(){return this.getClasses().join(" ")},getFirstChild:function(){return this.childs.getFirst()},getChilds:function(){return this.childs.get()},getChildExtent:function(){return this.childExtent},getFlowName:function(){return this.flow.getName()},getFlipFlow:function(){return this.flow.getFlipFlow()},getRestContentExtent:function(){return this.getContentExtent()-this.getChildExtent()},getContentMeasure:function(t){return this.size.getMeasure(t||this.flow)},getContentExtent:function(t){return this.size.getExtent(t||this.flow)},getMaxTextMeasure:function(t){var e=this.getContentMeasure(t||this.flow),n=i.fontSize;return"li-marker"===this._type||":first-letter"===this._type?Math.max(n,e):Math.max(n,e-n)},getMaxChildMeasure:function(t){var e=t||this.flow,n=0;return u.iter(this.getChilds(),function(t){var i=t.getTextMeasure?t.getTextMeasure():t.getContentMeasure(e);i>n&&(n=i)}),n},getContentWidth:function(){return this.size.width},getContentHeight:function(){return this.size.height},getBoxMeasure:function(t){var e=t||this.flow,n=this.getContentMeasure(e);return this.edge&&(n+=this.edge.getMeasureSize(e)),n},getBoxExtent:function(t){var e=t||this.flow,n=this.getContentExtent(e);return this.edge&&(n+=this.edge.getExtentSize(e)),n},getBoxWidth:function(){var t=this.size.width;return this.edge&&(t+=this.edge.getWidth()),t},getBoxHeight:function(){var t=this.size.height;return this.edge&&(t+=this.edge.getHeight()),t},getBoxSize:function(){return new j(this.getBoxWidth(),this.getBoxHeight())},getBorder:function(){return this.edge?this.edge.border:null},getRestSize:function(){var t=this.getContentMeasure(),e=this.getRestContentExtent();return this.flow.getBoxSize(t,e)},getAlignedWrapFlow:function(){return this.flow.getAlignedWrapFlow()},getParentFlow:function(){return this.parent?this.parent.flow:null},getParallelFlow:function(){return this.flow.getParallelFlow()},getParallelFlipFlow:function(){return this.flow.getParallelFlipFlow()},getPropStart:function(){return this.flow.getPropStart()},getPropAfter:function(){return this.flow.getPropAfter()},getInflow:function(){return this.flow.inflow},getBlockflow:function(){return this.flow.blockflow},getBoxFlowBoxSize:function(t,e){return this.flow.getBoxSize(t,e)},getEdgeWidth:function(){return this.edge?this.edge.getWidth():0},getEdgeHeight:function(){return this.edge?this.edge.getHeight():0},addClass:function(t){var e=this.extraClasses||[];e.push(t),this.extraClasses=e},addChild:function(t){this.childs.add(t),this.childExtent+=t.getBoxExtent(this.flow),this.charCount+=t.getCharCount()},addExtent:function(t){this.size.addExtent(this.flow,t)},addMeasure:function(t){this.size.addMeasure(this.flow,t)},setType:function(t){this._type=t},setId:function(t){this.id=t},setParent:function(t,e){var n=e!==void 0?e:!0;this.parent=t,n&&this.setFlow(t.flow)},setFlow:function(t){t.isValid()&&(this.flow=t)},setContentExtent:function(t,e){this.size.setExtent(t,e)},setContentMeasure:function(t,e){this.size.setMeasure(t,e)},setEdgeStart:function(t,e){this.edge&&this.edge.setEdgeStart(t,this.flow,e)},setEdgeEnd:function(t,e){this.edge&&this.edge.setEdgeEnd(t,this.flow,e)},setEdgeBefore:function(t,e){this.edge&&this.edge.setEdgeBefore(t,this.flow,e)},setEdgeAfter:function(t,e){this.edge&&this.edge.setEdgeAfter(t,this.flow,e)},setEdge:function(t){t instanceof G?this.edge=t:t._type&&(this.edge[t._type]=t)},setEdgeBySub:function(t){this.size.subEdge(t),this.size.isValid()&&this.setEdge(t)},subMeasure:function(t){this.size.subMeasure(this.flow,t)},splitMeasure:function(t){for(var e=this.getContentMeasure(),n=Math.floor(e/t),i=[],r=0;t>r;r++)i.push(n);return i},isEmptyChild:function(){return 0===this.childs.getLength()},isTextVertical:function(){return this.flow.isTextVertical()},isValidSize:function(){return this.size.isValid()},canInclude:function(t){return this.size.canInclude(t)},clearEdge:function(){this.edge&&this.edge.clear()},clearBorderBefore:function(){this.edge&&this.edge.clearBorderBefore(this.flow)},clearBorderAfter:function(){this.edge&&this.edge.clearBorderAfter(this.flow)},mapFontSize:function(t){return l.mapFontSize(t,this.fontSize)},mapBoxSize:function(t){return l.mapBoxSize(t,this.fontSize,this.getContentMeasure())},parseEdgeSize:function(t){return l.parseEdgeSize(t,this.fontSize,this.getContentMeasure())},shortenBox:function(t){var e=t||this.flow;return this.shortenMeasure(e),this.shortenExtent(e),this},shortenMeasure:function(t){var e=t||this.flow,n=this.getMaxChildMeasure(e);return this.setContentMeasure(e,n),this},shortenExtent:function(t){var e=t||this.flow;return this.setContentExtent(e,this.getChildExtent()),this}},t}(),Z=function(){function t(t){this._type="line-box",this.parent=t.parent,this.extent=t.extent||0,this.rubyLine=t.rubyLine||null,this.textLine=t.textLine||null}return t.prototype={_getLinesRubyLineFirst:function(){var t=[];return this.rubyLine&&t.push(this.rubyLine),this.textLine&&t.push(this.textLine),t},_getLinesTextLineFirst:function(){var t=[];return this.textLine&&t.push(this.textLine),this.rubyLine&&t.push(this.rubyLine),t},getLines:function(){var t=this.parent.flow;return t.isRubyLineFirst()?this._getLinesRubyLineFirst():this._getLinesTextLineFirst()},getCharCount:function(){return this.textLine?this.textLine.getCharCount():0},getTextLine:function(){return this.textLine},getRubyLine:function(){return this.rubyLine},getTextMeasure:function(){return this.textLine.getTextMeasure()},getContentMeasure:function(){return this.textLine.getContentMeasure()},getBoxExtent:function(){return this.extent}},t}(),$=function(){function t(t){this.css={},this._type=t.type||"text-line",this.size=t.size,this.fontSize=t.fontSize,this.color=t.color,this.parent=t.parent,this.textMeasure=t.textMeasure,this.textIndent=t.textIndent,this.tokens=t.tokens,this.emphaChars=t.emphaChars||null,this.lineRate=t.lineRate||1,this.bodyLine=t.bodyLine||null,this.charCount=t.charCount||0,this.letterSpacing=t.letterSpacing||0,this.textAlign=this.parent.textAlign,this.flow=this.parent.flow}return t.prototype={isTextVertical:function(){return this.flow.isTextVertical()},isTextLine:function(){return"text-line"===this._type},isRubyLine:function(){return"ruby-line"===this._type},setEdge:function(t){this.edge=t},getCharCount:function(){return this.charCount},getTextMeasure:function(){return this.textMeasure},getTextRestMeasure:function(){return this.getMaxTextMeasure()-this.textMeasure},getMaxTextMeasure:function(){return X.prototype.getMaxTextMeasure.call(this)},getContentMeasure:function(t){return this.size.getMeasure(t||this.flow)},getContentExtent:function(t){return this.size.getExtent(t||this.flow)},getRestContentExtent:function(t){return this.getContentExtent(t||this.flow)},getBodyLineContentExtent:function(){return this.bodyLine.getContentExtent()},getBoxExtent:function(t){var e=t||this.flow,n=this.size.getExtent(e);return this.edge&&(n+=this.edge.getExtentSize(e)),n},getTextSide:function(){return this.flow.getTextSide()},getPropStart:function(){return this.flow.getPropStart()},getPropAfter:function(){return this.flow.getPropAfter()},getPropBefore:function(){return this.flow.getPropBefore()},getStartOffset:function(){switch(this.textAlign){case"start":return this.textIndent;case"end":return this.textIndent+this.getTextRestMeasure();
case"center":return this.textIndent+Math.floor(this.getTextRestMeasure()/2);default:return this.textIndent}},getCss:function(){var t=this.css;m.copy(t,this.size.getCss()),this.parent&&m.copy(t,this.flow.getCss());var e=this.getStartOffset();return e&&(this.edge=new W,this.edge.setStart(this.flow,e)),this.edge&&m.copy(t,this.edge.getCss()),this.isTextVertical()&&r.isIphoneFamily&&(t["letter-spacing"]="-0.001em"),"ruby-line"===this._type&&this.flow.isTextHorizontal()&&(t["line-height"]=this.getContentExtent()+"px"),t},getCssClasses:function(){return this.getClasses().join(" ")},getClasses:function(){return[["nehan",this._type].join("-"),["nehan",this._type,this.isTextVertical()?"vert":"hori"].join("-")]},getTextHorizontalDir:function(){return this.flow.getTextHorizontalDir()},shortenMeasure:function(){this.size.setMeasure(this.flow,this.textMeasure)}},t}(),Y=function(){function t(t){this.pos=0,this.buff=t,this.bufferLength=this.buff.length,this.empty=""===this.buff}var e=/\d\d|!\?|!!|\?!|\?\?/,n=/^([\w!\.\?\/\_:#;"',]+)/,i=/^(<[^>]+>)/,r=/^(&[^;\s]+;)/;return t.prototype={isEmpty:function(){return this.empty},get:function(){var t=this._getToken();return t&&(t.spos=this.pos),t},getBufferLength:function(){return this.bufferLength},getSeekPercent:function(t){return Math.floor(100*t/this.bufferLength)},_stepBuff:function(t){this.pos+=t,this.buff=this.buff.slice(t)},_getToken:function(){if(""===this.buff)return null;if(this.buff.match(i))return this._parseTag(RegExp.$1);if(this.buff.match(n)){var t=RegExp.$1;return 1===t.length?this._parseChar(t):2===t.length&&t.match(e)?this._parseTcy(t):this._parseWord(t)}return this.buff.match(r)?this._parseCharRef(RegExp.$1):this._parseChar(this._getChar())},_getRb:function(){var t=this.buffRb.substring(0,1);return this.buffRb=this.buffRb.slice(1),t},_getChar:function(){return this.buff.substring(0,1)},_getTagContent:function(t){var e="<"+t,n="</"+t,i=function(i,r){var s=arguments.callee,a=i.indexOf(e,r),o=i.indexOf(n,r);if(0>a||a>o)return o;var u=s(i,a+t.length+2);return s(i,u+t.length+3)},r=i(this.buff,0);return 0>r?this.buff:this.buff.substring(0,r)},_parseTag:function(t){var e=new b(t);return this._stepBuff(t.length),e.isTcyTag()?this._parseTcyTag(e):e.isChildContentTag()?this._parseChildContentTag(e):e},_parseTcyTag:function(t){var e=this._getTagContent(t.name);return this._stepBuff(e.length+t.name.length+3),new S(e)},_parseChildContentTag:function(t){var e=this._getTagContent(t.name);return t.setContent(c.trimCRLF(e)),this._stepBuff(e.length+t.name.length+3),t},_parseWord:function(t){return this._stepBuff(t.length),new v(t)},_parseTcy:function(t){return this._stepBuff(t.length),new S(t)},_parseChar:function(t){return this._stepBuff(t.length),new y(t,!1)},_parseCharRef:function(t){return this._stepBuff(t.length),new y(t,!0)}},t}(),J=function(){function t(){this.tags=[],this.head=null}return t.prototype={isEmpty:function(){return 0>=this.tags.length},isTagNameEnable:function(t){return this.exists(function(e){return e.getName()==t})},getDepth:function(){return this.tags.length},getDepthByName:function(t){return u.count(this.tags,function(e){return e.getName()==t})},getHead:function(){return this.head},pop:function(){var t=this.tags.pop();return this.head=this._getCurHead(),t},push:function(t){this.head=t,this.tags.push(t)},exists:function(t){return u.exists(this.tags,t)},find:function(t){return u.find(this.tags,t)},revfind:function(t){return u.revfind(this.tags,t)},iter:function(t){u.iter(this.tags,t)},reviter:function(t){u.revIter(this.tags,t)},filter:function(t){return u.filter(this.tags,t)},getByName:function(t){for(var e=this.tags.length-1;e>=0;e--){var n=this.tags[e];if(n.name==t)return n}return null},popByName:function(t){for(var e=this.tags.length-1;e>=0;e--){var n=this.tags[e];if(n.name==t){var i=this.tags.splice(e,1)[0];return this.head=this._getCurHead(),i}}return null},_getCurHead:function(){return 0===this.tags.length?null:this.tags[this.tags.length-1]}},t}(),Q=function(){function t(t,e,n){this.rank=t,this.title=e,this._id=n||0}return t.prototype={getId:function(){return this._id},debug:function(){return["title:"+this.title,"rank:"+this.rank].join(", ")}},t}(),te=function(){function t(t,e,n){this._type=t,this._header=null,this._auto=!1,this._next=null,this._child=null,this._parent=e||null,this._pageNo=n||0}return t.prototype={isRoot:function(){return null===this._parent},isAuto:function(){return this._auto},hasHeader:function(){return null!==this._header},hasHeaderId:function(){return this.getHeaderId()>0},hasChild:function(){return null!==this._child},hasNext:function(){return null!==this._next},getNext:function(){return this._next},getChild:function(){return this._child},getParent:function(){return this._parent},getHeader:function(){return this._header},getHeaderId:function(){return this._header?this._header.getId():null},setHeader:function(t){this._header=t},setAuto:function(){this._auto=!0},getRank:function(){return this._header?this._header.rank:0},getTitle:function(){return this._header?this._header.title:["untitled",this._type].join(" ")},getType:function(){return this._type},getPageNo:function(){return this._pageNo},updatePageNo:function(t){this._pageNo=t},addChild:function(t){null===this._child?this._child=t:this._child.addNext(t)},addNext:function(t){null===this._next?this._next=t:this._next.addNext(t)},debug:function(){return this._header?this._header.debug():"no header"}},t}(),ee=function(){function t(){this.stack=[1]}return t.prototype={getTocStack:function(){return this.stack},getTocId:function(){return this.stack.join(".")},stepNext:function(){var t=this.stack.length;return t>0&&this.stack[t-1]++,this},startRoot:function(){return this.stack.push(1),this},endRoot:function(){return this.stack.pop(),this}},t}(),ne=function(){function t(t){this.rootName=t,this.logs=[]}return t.prototype={_isSameLog:function(t,e){for(var n in t)if("pageNo"!=n&&"headerId"!=n&&t[n]!=e[n])return!1;return!0},_findLog:function(t){for(var e=this.logs.length-1;e>=0;e--)if(this._isSameLog(t,this.logs[e]))return e;return-1},addSectionLog:function(t){this.logs.push(t)},addHeaderLog:function(t){var e=this._findLog(t);return e>=0?(this.logs[e]=t,void 0):(this.logs.push(t),void 0)},get:function(t){return this.logs[t]||null}},t}(),ie=function(){function t(){this.rootLogs={},this.rootStack=[],this.curRootSection="body"}return t.prototype={_addHeaderLog:function(t){var e=this.getRootLog(this.curRootSection);e.addHeaderLog(t)},_addSectionLog:function(t){var e=this.getRootLog(this.curRootSection);e.addSectionLog(t)},getRootLog:function(t){var e=this.rootLogs[t]||new ne(t);return this.rootLogs[t]=e,e},startSectionRoot:function(t){this.rootStack.push(t),this.curRootSection=t},endSectionRoot:function(){return this.curRootSection=this.rootStack.pop()||"body",this.curRootSection},logStartSection:function(t,e){this._addSectionLog({name:"start-section",type:t,pageNo:e})},logEndSection:function(t){this._addSectionLog({name:"end-section",type:t})},logSectionHeader:function(t,e,n,i,r){this._addHeaderLog({name:"set-header",type:t,rank:e,title:n,pageNo:i,headerId:r})}},t}(),re=function(){function t(t){this._ptr=0,this._logs=t,this._root=new te("section",null,0)}return t.prototype={yield:function(){return this._parse(this._root,this),this._root},_getNext:function(){return this._logs.get(this._ptr++)},_rollback:function(){this._ptr=Math.max(0,this._ptr-1)},_parse:function(t,e){var n=e._getNext();if(null!==n)switch(n.name){case"start-section":var i=new te(n.type,t,n.pageNo);t&&t.addChild(i),arguments.callee(i,e);break;case"end-section":arguments.callee(t.getParent(),e);break;case"set-header":var r=new Q(n.rank,n.title,n.headerId);if(null===t){var s=new te("section",null,n.pageNo);s.setHeader(r),arguments.callee(s,e)}else if(t.hasHeader()){var a=n.rank,o=t.getRank();if(o>a)e._rollback(),arguments.callee(t.getParent(),e);else if(n.rank==o){var u=new te("section",t,n.pageNo);u.setHeader(r),t.addNext(u),arguments.callee(u,e)}else{var h=new te("section",t,n.pageNo);h.setHeader(r),t.addChild(h),arguments.callee(h,e)}}else t.setHeader(r),arguments.callee(t,e)}}},t}(),se=function(){function t(t,e){this.tree=t,m.update(this,e||{})}return t.prototype={outputNode:function(){var t=new ee;return this._parseTree(this,this.createRoot(),this.tree,t)},_createToc:function(t,e){return{tocId:e.getTocId(),headerId:t.getHeaderId()}},_parseTree:function(t,e,n,i){if(null===n)return e;var r=t._createToc(n,i),s=t.createChild(r),a=n.getPageNo(),o=t.createTitle(n.getTitle(),a,r),u=t.createLink(o,a,r);u.onclick=function(){return t.onClickLink(a,u,r)},s.appendChild(u),e.appendChild(s);var h=n.getChild();if(h){i=i.startRoot();var l=t._createToc(h,i),c=t.createRoot(l);arguments.callee(t,c,h,i),s.appendChild(c),i=i.endRoot()}var f=n.getNext();return f&&arguments.callee(t,e,f,i.stepNext()),e},onClickLink:function(){return!1},createRoot:function(){return document.createElement("ol")},createChild:function(){return document.createElement("li")},createTitle:function(t){return t.replace(/<a[^>]+>/gi,"").replace(/<\/a>/gi,"")},createLink:function(t,e,n){var i=document.createElement("a");return i.href="#"+e,i.innerHTML=t,i.className="nehan-toc-link",i.id=g.addNehanTocLinkPrefix(n.tocId),i}},t}(),ae=function(){function t(){this.values={}}return t.prototype={get:function(t){var e=this.values[t]||null;return e?1===e.length?e[0]:e:null},add:function(t,e){var n=this.values[t]||null;n?n.push(e):this.values[t]=[e]}},t}(),oe=function(){function t(){this.tagStack=new J}return t.prototype={pushBlock:function(t){var e=this.getHead();e&&t.inherit(e),this.tagStack.push(t)},popBlock:function(){return this.tagStack.pop()},getHead:function(){return this.tagStack.getHead()},getTagStack:function(){return this.tagStack},getDepth:function(){return this.tagStack.getDepth()},getDepthByName:function(t){return this.tagStack.getDepthByName(t)},findTag:function(t){return this.tagStack.find(t)},isEmpty:function(){return this.tagStack.isEmpty()},isTagEnable:function(t){return this.tagStack.exists(t)},isHeaderEnable:function(){return this.tagStack.exists(function(t){return t.isHeaderTag()})},isTagNameEnable:function(t){return this.tagStack.isTagNameEnable(t)}},t}(),ue=function(){function t(){this.tagStack=new J,this.fontSizeStack=[],this.fontColorStack=[],this.linePos=0}return t.prototype={setFixedFontSize:function(t){this.fixedFontSize=t},getTagStack:function(){return this.tagStack},getFontSize:function(t){return this.fixedFontSize?this.fixedFontSize:this.fontSizeStack.length>0?this.fontSizeStack[this.fontSizeStack.length-1]:t.fontSize},getFontColor:function(t){return this.fontColorStack.length>0?this.fontColorStack[this.fontColorStack.length-1]:t.color},getHead:function(){return this.tagStack.getHead()},getTagDepth:function(){return this.tagStack.getDepth()},isTagEnable:function(t){return this.tagStack.exists(t)},isTagNameEnable:function(t){return this.tagStack.isTagNameEnable(t)},isBoldEnable:function(){return this.tagStack.exists(function(t){return t.isBoldTag()})},isEmpty:function(){return this.tagStack.isEmpty()},findTag:function(t){return this.tagStack.find(t)},findLastTagByName:function(t){return this.tagStack.revfind(function(e){return e.getName()==t})},pushTag:function(t,e){var n=t.getCssAttr("font-size");if(n){var i=this.getFontSize(e),r=l.mapFontSize(n,i);t.setFontSizeUpdate(r),this.fontSizeStack.push(r)}var s=t.getCssAttr("color");s&&(this.getFontColor(e),t.setFontColorUpdate(s),this.fontColorStack.push(s)),this.tagStack.push(t)},popTag:function(){var t=this.tagStack.pop();return t&&this._updateStatus(t),t},popTagByName:function(t){var e=this.tagStack.popByName(t);return e&&this._updateStatus(e),e},_updateStatus:function(t){t.fontSize&&this.fontSizeStack.length>0&&this.fontSizeStack.pop(),t.color&&this.fontColorStack.length>0&&this.fontColorStack.pop()}},t}(),he=function(){function t(){this.localStyles={},this.globalStyles=[]}return t.prototype={addLocalStyle:function(t,e){var n=this.localStyles[e]||[];n.push(t),this.localStyles[e]=n},addGlobalStyle:function(t){this.globalStyles.push(t)},getLocalStyles:function(t){return this.localStyles[t]||[]},getGlobalStyles:function(){return this.globalStyles}},t}(),le=function(){function t(t){var e=t||{};this.charPos=e.charPos||0,this.pageNo=e.pageNo||0,this.meta=e.meta||new ae,this.blockContext=e.blockContext||new oe,this.inlineContext=e.inlineContext||new ue,this.styleContext=e.styleContext||new he,this.outlineContext=e.outlineContext||new ie,this.anchors=e.anchors||{}}var e=0;return t.prototype={setTitle:function(t){this.setMeta("title",t)},getTitle:function(){return this.getMeta("title")},setMeta:function(t,e){this.meta.add(t,e)},getMeta:function(t){return this.meta.get(t)},getPageNo:function(){return this.pageNo},getCharPos:function(){return this.charPos},stepPageNo:function(){this.pageNo++},addCharPos:function(t){this.charPos+=t},createInlineRoot:function(){return new t({charPos:this.charPos,pageNo:this.pageNo,meta:this.meta,anchors:this.anchors,outlineContext:this.outlineContext,blockContext:this.blockContext,styleContext:this.styleContext})},isEmptyMarkupContext:function(){return this.inlineContext.isEmpty()},addStyle:function(t){var e=t.getDataset("scope","global");"local"===e?this.styleContext.addLocalStyle(t,this.pageNo):this.styleContext.addGlobalStyle(t)},getPageStyles:function(t){var e=this.getGlobalStyles(),n=this.getLocalStyles(t);return e.concat(n)},getLocalStyles:function(t){var e=t!==void 0?t:this.pageNo;return this.styleContext.getLocalStyles(e)},getGlobalStyles:function(){return this.styleContext.getGlobalStyles()},setAnchor:function(t){this.anchors[t]=this.pageNo},getAnchors:function(){return this.anchors},getAnchorPageNo:function(t){return this.anchors[t]},getInlineFontSize:function(t){return this.inlineContext.getFontSize(t)},getInlineFontColor:function(t){return this.inlineContext.getFontColor(t)},getInlineTagStack:function(){return this.inlineContext.getTagStack()},getInlineTagDepth:function(){return this.inlineContext.getTagDepth()},pushInlineTag:function(t,e){this.inlineContext.pushTag(t,e)},popInlineTag:function(){return this.inlineContext.popTag()},popInlineTagByName:function(t){return this.inlineContext.popTagByName(t)},findLastInlineTagByName:function(t){return this.inlineContext.findLastTagByName(t)},findInlineTag:function(t){return this.inlineContext.findTag(t)},isInlineTagEnable:function(t){return this.inlineContext.isTagEnable(t)},isBoldEnable:function(){return this.inlineContext.isBoldEnable()?!0:this.isHeaderEnable()},setFixedFontSize:function(t){this.inlineContext.setFixedFontSize(t)},isHeaderEnable:function(){return this.blockContext.isHeaderEnable()},pushBlock:function(t){this.blockContext.pushBlock(t)},popBlock:function(){return this.blockContext.popBlock()},getBlockTagStack:function(){return this.blockContext.getTagStack()},getCurBlock:function(){return this.blockContext.getHead()},getBlockDepth:function(){return this.blockContext.getDepth()},getBlockDepthByName:function(t){return this.blockContext.getDepthByName(t)},getOutlineTitle:function(){return this.blockContext.getOutlineTitle()},findBlockTag:function(t){return this.blockContext.findTag(t)},isBlockTagEnable:function(t){return this.blockContext.isTagEnable(t)},getOutlineLog:function(t){return this.outlineContext.getRootLog(t)},startSectionRoot:function(t){var e=t.getName();this.outlineContext.startSectionRoot(e)},endSectionRoot:function(t){var e=t.getName();return this.outlineContext.endSectionRoot(e)},logStartSection:function(t){var e=t.getName();this.outlineContext.logStartSection(e,this.pageNo)},logEndSection:function(t){var e=t.getName();this.outlineContext.logEndSection(e)},logSectionHeader:function(t){var n=t.getName(),i=t.getHeaderRank(),r=t.content,s=this.pageNo,a=e++;return this.outlineContext.logSectionHeader(n,i,r,s,a),a}},t}(),ce=function(){function t(t,e){this.rowCount=t,this.maxCol=e,this.map=this._create(t,e)}return t.prototype={_create:function(t,e){for(var n=[],i=function(t){for(var e=[],n=0;t>n;n++)e.push({start:0,end:0,before:0,after:0});return e},r=0;t>r;r++)n.push(i(e));return n},get:function(t,e){return this.map[t][e]},getAsStyle:function(t,e){var n=this.get(t,e),i={};for(var r in n)i[r]=n[r]+"px";return i},set:function(t,e,n){for(var i in n)this.setBorderProp(t,e,i,n)},collapse:function(){this._collapseCol(),this._collapseRow()},_collapseCol:function(){for(var t=0;this.rowCount>t;t++)for(var e=0;this.maxCol-1>e;e++){var n=this.get(t,e),i=this.get(t,e+1);n.end&&i.start&&(n.end>i.start?i.start=0:n.end=0)}},_collapseRow:function(){for(var t=0;this.rowCount-1>t;t++)for(var e=0;this.maxCol>e;e++){var n=this.get(t,e),i=this.get(t+1,e);n.after&&i.before&&(n.after>i.before?i.before=0:n.after=0)}},setBorderProp:function(t,e,n,i){var r=this.get(t,e);i[n]>r[n]&&(r[n]=i[n])},setRange:function(t,e,n,i,r){for(var s=t;n>s;s++)for(var a=e;i>a;a++)s==t&&this.setBorderProp(s,a,"before",r),s==n-1&&this.setBorderProp(s,a,"after",r),a==e&&this.setBorderProp(s,a,"start",r),a==i-1&&this.setBorderProp(s,a,"end",r)}},t}(),fe=function(){var t=function(t,e){var n=e.getCssAttr("border");if(null===n)return null;var i=t.parseEdgeSize(n);return"number"==typeof i?{before:i,after:i,start:i,end:i}:i},e=function(e,n,i){var r=t(n,i);if(null!==r)switch(i.name){case"table":e.setRange(0,0,e.rowCount,e.maxCol,r);break;case"thead":case"tbody":case"tfoot":var s=i.row,a=s+i.childs.length;e.setRange(s,0,a,e.maxCol);break;case"tr":e.setRange(i.row,0,i.row+1,e.maxCol);break;case"td":case"th":e.set(i.row,i.col,r)}},n=function(t,n,i){var r=arguments.callee;e(t,n,i),u.iter(i.childs||[],function(e){r(t,n,e)})},i=function(t,e){var n=arguments.callee;switch(e.name){case"table":case"thead":case"tbody":case"tfoot":case"tr":e.setCssAttr("border","0px");break;case"td":case"th":var i=t.getAsStyle(e.row,e.col);e.setCssAttr("border",i)}u.iter(e.childs||[],function(e){n(t,e)})};return{set:function(t,e){var r=new ce(t.rowCount,t.maxCol);n(r,e,t),r.collapse(),i(r,t)}}}(),ge=o.extend({init:function(t){this.lexer=new Y(t),this.tokens=[],this.pos=0,this.backupPos=0,this.eof=!1,this._doBuffer()},hasNext:function(){return!this.isEnd()},isEmpty:function(){return this.lexer.isEmpty()},isHead:function(){return 0===this.pos},isEnd:function(){return this.eof&&this.pos>=this.tokens.length},backup:function(){this.backupPos=this.pos},rollback:function(){this.pos=this.backupPos},next:function(t){var e=t||1;this.pos=this.pos+e},prev:function(){this.pos=Math.max(0,this.pos-1)},setPos:function(t){this.pos=t},skipUntil:function(t){for(;;){var e=this.peek();if(null===e)break;if(!t(e)){this.prev();break}this.next()}},peek:function(t){var e=t||0,n=Math.max(0,this.pos+e);if(n>=this.tokens.length){if(this.eof)return null;this._doBuffer()}var i=this.tokens[n];return i.pos=n,i},get:function(){var t=this.peek();return this.pos++,t},getPos:function(){return this.pos},getAll:function(){for(;!this.eof;)this._doBuffer();return this.tokens},getAllIf:function(t){return u.filter(this.getAll(),function(e){return t(e)})},getTokenCount:function(){return this.tokens.length},getSeekPos:function(){var t=this.tokens[this.pos];return t?t.spos:0},getSeekPercent:function(){var t=this.getSeekPos();return this.lexer.getSeekPercent(t)},iterWhile:function(t,e){for(var n=1==arguments.length?this.pos:t;n>=0;){if(n>=this.tokens.length){if(this.eof)break;this._doBuffer(),this.iterWhile(n,e);break}if(!e(n,this.tokens[n]))break;n++}},revIterWhile:function(t,e){for(var n=1==arguments.length?this.pos:t;n>=0&&e(n,this.tokens[n]);)n--},findTextPrev:function(t){var e=e!==void 0?t:this.pos,n=null;return this.revIterWhile(e-1,function(t,e){return x.isText(e)?(n=e,!1):!0}),n},findTextNext:function(t){var e=t!==void 0?t:this.pos,n=null;return this.iterWhile(e+1,function(t,e){return x.isText(e)?(n=e,!1):!0}),n},_doBuffer:function(){for(var t=this,e=n.lexingBufferLen,i=function(e){t.tokens.push(e)},r=0;e>r;r++){var s=this.lexer.get();if(null===s){this.eof=!0;break}i(s)}}}),de=ge.extend({init:function(t,e){var n=0;this._super(t),this.tokens=this.getAllIf(function(t){return x.isText(t)?!1:e(t)?(t.order=n++,!0):void 0})}}),pe=ge.extend({init:function(t){this._super(""),this.tokens=t},isEmpty:function(){return 0===this.tokens.length}});ge.extend({init:function(t){this._super(t),this.tokens=this.getAllIf(function(t){return x.isText(t)?!0:t.isInline()||t.isInlineBlock()})}});var me=de.extend({init:function(t){this._super(t,function(t){return t.isSameAs("!doctype")||t.isSameAs("html")})}}),ke=de.extend({init:function(t){this._super(t,function(t){return t.isSameAs("head")||t.isSameAs("body")})}}),be=de.extend({init:function(t){this._super(t,function(t){return t.isSameAs("title")||t.isSameAs("meta")||t.isSameAs("link")||t.isSameAs("style")||t.isSameAs("script")})}}),xe=de.extend({init:function(t){this._super(t.content,function(t){return t.isSameAs("thead")||t.isSameAs("tbody")||t.isSameAs("tfoot")||t.isSameAs("tr")}),this.markup=t,this.markup.childs=this.tokens=this._parseTokens(this.tokens)},getPartition:function(t){var e=this,n=new D,i=t.getContentMeasure();return u.iter(this.tokens,function(r){var s=r.childs;u.iter(s,function(r){var s=r.childs,a=s.length;if(null===n.getPartition(a)){var o=e._parsePartition(s,t);n.add(new K(o,i))}})}),n},_setChildTokens:function(t,e){t.childs=e;var n=e.length;return n>0&&(t.firstChild=e[0],t.lastChild=e[n-1]),t},_parseTokens:function(t){var e=[],n=[],i=[],r=this,s=null,a=null,o=null,h={row:0,col:0,maxCol:0};u.iter(t,function(t){if(x.isTag(t))switch(t.name){case"tr":t.row=h.row,r._setChildTokens(t,r._parseCols(h,t.content)),h.row++,i.push(t);break;case"thead":s=t,e=e.concat(r._parseRows(h,t.content));break;case"tbody":a=t,i=i.concat(r._parseRows(h,t.content));break;case"tfoot":o=t,n=n.concat(r._parseRows(h,t.content))}});var l=[],c=0;return e.length>0&&(null===s&&(s=new b("<thead>")),this._setChildTokens(s,e),s.row=c,c+=s.childs.length,l.push(s)),i.length>0&&(null===a&&(a=new b("<tbody>")),this._setChildTokens(a,i),a.row=c,c+=a.childs.length,l.push(a)),n.length>0&&(null===o&&(o=new b("<tfoot>")),this._setChildTokens(o,n),o.row=c,l.push(o)),this._setChildTokens(this.markup,l),this.markup.maxCol=h.maxCol,this.markup.rowCount=h.row,l},_parsePartition:function(t,e){return u.map(t,function(t){var n=t.getTagAttr("measure")||t.getTagAttr("width")||0;return n?e.mapBoxSize(n):0})},_parseRows:function(t,e){var n=this,i=new de(e,function(t){return t.isSameAs("tr")}).getAll();return u.map(i,function(e){return e.row=t.row,e=n._setChildTokens(e,n._parseCols(t,e.content)),t.row++,e})},_parseCols:function(t,e){var n=new de(e,function(t){return t.isSameAs("td")||t.isSameAs("th")}).getAll();return u.iteri(n,function(e,n){n.row=t.row,n.col=e}),n.length>t.maxCol&&(t.maxCol=n.length),n}}),ye=de.extend({init:function(t){this._super(t,function(t){return t.isSameAs("li")})}}),ve=de.extend({init:function(t){this._super(t,function(t){return t.isSameAs("dt")||t.isSameAs("dd")})}}),Se=function(){function t(t){this.rubies=this._parseAll(new ge(t)),this.pos=0}return t.prototype={backup:function(){this.backupPos=this.pos},rollback:function(){this.backupPos!==void 0&&(this.pos=this.backupPos)},hasNext:function(){return this.pos<this.rubies.length},peek:function(){return this.hasNext()?this.rubies[this.pos]:null},get:function(){var t=this.peek();return t.index=this.pos,this.pos++,t},_parseAll:function(t){for(var e=[];t.hasNext();)e.push(this._parseRuby(t));return e},_parseRuby:function(t){for(var e=[],n=null;;){var i=t.get();if(null===i)break;if(x.isTag(i)&&"rt"===i.getName()){n=i;break}x.isText(i)&&e.push(i)}return new C(e,n)}},t}(),Ce=function(){function t(t){if(this.context=new le,this.stream=new me(t),this.generator=this._createGenerator(),null===this.generator)throw"DocumentGenerator::invalid document"}return t.prototype={yield:function(){return this.generator.yield()},hasNext:function(){return this.generator.hasNext()},getTitle:function(){return this.context.getTitle()},getMeta:function(t){return this.context.getMeta(t)},getOutline:function(t){return this.generator.getOutline(t)},getOutlineHtml:function(t){return this.generator.getOutlineHtml(t)},_parseDocType:function(){},_createGenerator:function(){for(var t=null;;){var e=this.stream.get();if(null===e)break;switch(e.getName()){case"!doctype":this._parseDocType(e);break;case"html":t=new _e(e,this.context)}}return t}},t}(),_e=function(){function t(t,e){if(this.markup=t,this.context=e||new le,this.stream=this._createStream(),this.generator=this._getGenerator(),null===this.generator)throw"HtmlGenerator::invalid html"}return t.prototype={yield:function(){return this.generator.yield()},hasNext:function(){return this.generator.hasNext()},getOutline:function(t){return this.generator.getOutline(t)},getOutlineHtml:function(t){return this.generator.getOutlineHtml(t)},_createStream:function(){return new ke(this.markup.content)},_getGenerator:function(){for(var t=null;;){var e=this.stream.get();if(null===e)break;switch(e.getName()){case"head":this._parseHead(e.content);break;case"body":t=new Ve(e,this.context)}}return t},_parseHead:function(t){for(var e=new be(t);;){var n=e.get();if(null===n)break;switch(n.getName()){case"title":this._parseTitle(n);break;case"meta":this._parseMeta(n);break;case"link":this._parseLink(n);break;case"style":this._parseStyle(n);break;case"script":this._parseScript(n)}}},_parseTitle:function(t){this.context.setTitle(t.content)},_parseMeta:function(t){var e=this.context;t.iterTagAttr(function(t,n){e.setMeta(t,n)})},_parseLink:function(){},_parseStyle:function(){},_parseScript:function(){}},t}(),we=o.extend({init:function(t,e){this.markup=t,this.context=e},hasNext:function(){return!1},backup:function(){},rollback:function(){},yield:function(){throw"BlockGenerator::yield not impletented"},getCurGenerator:function(){return this.generator&&this.generator.hasNext()?this.generator:null},_onReadyMarkupEvent:function(t){a.isEnable("onReadyMarkup")&&a.callHandlers(this.markup.getCssKeys(),"onReadyMarkup",{context:this.context,markup:this.markup,parent:t})},_onReadyBox:function(){},_onReadyBoxEvent:function(t){a.isEnable("onReadyBox")&&a.callHandlers(this.markup.getCssKeys(),"onReadyBox",{context:this.context,box:t})},_onCompleteBox:function(){},_getBoxType:function(){return this.markup.getName()},_setEdge:function(t,e){t.setEdgeBySub(e)},_getEdgeSize:function(t,e){var n=this.markup.getCssAttr(e);return n?t.parseEdgeSize(n):null},_isFirstChild:function(t,e){return"li-marker"==t._type||"li-body"==t._type?!1:e.isEmptyChild()},_setBoxStyle:function(t,e){e&&this._isFirstChild(t,e)&&this.markup.setFirstChild();var n=e?e.fontSize:i.fontSize,r=this.markup.getCssAttr("font-size","inherit");"inherit"!=r&&(t.fontSize=l.mapFontSize(r,n));var s=this.markup.getCssAttr("color","inherit");"inherit"!=s&&(t.color=s);var a=this._getEdgeSize(t,"padding"),o=this._getEdgeSize(t,"margin"),h=this._getEdgeSize(t,"border");if(a||o||h){var c=new G;a&&c.setSize("padding",t.flow,a),o&&c.setSize("margin",t.flow,o),h&&c.setSize("border",t.flow,h),this._setEdge(t,c)}var f=this.markup.getCssAttr("line-rate");f&&(t.lineRate=f);var g=this.markup.getCssAttr("text-align");g&&(t.textAlign=g);var d=this.markup.getCssAttr("flow");if(d)switch(d){case"flip":t.setFlow(e.getFlipFlow());break;case"inherit":t.setFlow(e.flow);break;default:t.setFlow(N.getByName(d))}var p=this.markup.getCssAttr("block-align","none");"none"!=p&&(t.blockAlign=p);var m=this.markup.getCssAttr("text-indent",0);m&&(t.textIndent=t.fontSize);var k=this.markup.getCssAttr("page-break-after",!1);k&&(t.pageBreakAfter=!0);var b=this.markup.getCssAttr("letter-spacing");b&&(t.letterSpacing=l.mapFontSize(b,n)),u.iter(this.markup.classes,function(e){t.addClass(e)})},_createBox:function(t,e){this._onReadyMarkupEvent(e);var n=this._getBoxType(),r=i.createBox(t,e,n);return this._onReadyBox(r,e),this._onReadyBoxEvent(r),this._setBoxStyle(r,e),this._onCompleteBox(r,e),r}}),Te=we.extend({yield:function(t,e){var r=this._createBox(e,t);this.markup.isPush()&&(r.backward=!0),this.markup.isPull()&&(r.forward=!0);var s=t.getRestSize();if(s.width-=r.getEdgeWidth(),s.height-=r.getEdgeHeight(),!s.isValid())return k.RETRY;if(s.canInclude(r.size))return r;var a=i.getStdPageSize(),o=r.size.resizeWithin(t.flow,s);return!a.canInclude(r.size)||o.percentFrom(r.size)>=n.minBlockScaleDownRate?(r.size=o,r):k.RETRY},_setEdge:function(t,e){return t.setEdge(e),t}}),Be=Te.extend({_getBoxType:function(){return"ibox"},_getBoxContent:function(){return this.markup.isChildContentTag()?this.markup.getWrapSrc():this.markup.getSrc()},_onCompleteBox:function(t){t.content=this._getBoxContent(),t.css.overflow="hidden"}}),Ee=Te.extend({_onCompleteBox:function(t){t.src=this.markup.getTagAttr("src")}}),ze=Te.extend({yield:function(t){var e=t.getContentMeasure(),n=t.flow.getBoxSize(e,1);return this._super(t,n)}}),Pe=function(){function t(t){this.markup=t,this.stream=new Se(t.content)}return t.prototype={backup:function(){this.stream.backup()},rollback:function(){this.stream.rollback()},hasNext:function(){return this.stream.hasNext()},yield:function(t){this.backup();var e=this.stream.get();return null===e?null:(e.setStartPos(t.curMeasure),e.hasMetrics()||e.setMetrics(t.getParentFlow(),this.markup.fontSize,this.markup.letterSpacing),e)}},t}(),Ae=function(){function t(t,e,n){this.parent=t,this.stream=e,this.context=n,this.isRubyLine="ruby-line"===t._type,this.lineStartPos=this.stream.getPos(),this.lineRate=t.lineRate,this.letterSpacing=t.letterSpacing||0,this.textIndent=e.isHead()?t.textIndent||0:0,this.maxFontSize=t.fontSize,this.maxExtent=0,this.maxMeasure=t.getMaxTextMeasure()-this.textIndent,this.curMeasure=0,this.restMeasure=this.maxMeasure,this.restExtent=t.getRestContentExtent(),this.lineMeasure=t.getContentMeasure()-this.textIndent,this.rubyLineRate=Math.max(0,this.lineRate-1),this.rubyLineExtent=this.isRubyLine?0:Math.floor(t.fontSize*this.rubyLineRate),this.bodyTokens=[],this.rubyTokens=[],this.emphaChars=[],this.lineBreak=!1,this.charCount=0,this.lastToken=null,this.prevText=null,this.lastText=null}return t.prototype={canContainBasicLine:function(){return this.restExtent>=Math.floor(this.parent.fontSize*this.lineRate)},canContainExtent:function(t){return this.restExtent>=t},canContainAdvance:function(t){return this.restMeasure>=t},canContain:function(t,e){return this.canContainAdvance(t)&&this.canContainExtent(e)},isPreLine:function(){return"pre"===this.parent._type},isEmptySpace:function(){return 0>=this.restMeasure},isBoldEnable:function(){return this.context.isBoldEnable()},isEmptyText:function(){return 0===this.bodyTokens.length},isInlineTagEmpty:function(){return 0>=this.context.getInlineTagDepth()},isOverWithoutLineBreak:function(){return!this.lineBreak&&this.bodyTokens.length>0},isLineStart:function(){return this.stream.pos==this.lineStartPos},isFirstLine:function(){return 0===this.lineStartPos},pushTag:function(t){this.context.pushInlineTag(t,this.parent)},pushBackToken:function(){this.stream.prev()},popFirstLine:function(){var t=this.context.popInlineTagByName(":first-line");t&&this.addElement(t.getCloseTag(),{advance:0,extent:0,fontSize:0})},popTagByName:function(t){this.context.popInlineTagByName(t)},findFirstText:function(){return this.stream.findTextNext(this.lineStartPos)},skipToken:function(){this.stream.next()},getNextToken:function(){var t=this.stream.get();if(t&&this.isLineStart()&&x.isChar(t)&&t.isHalfSpaceChar()){var e=this.findFirstText();e&&x.isWord(e)&&(t=this.stream.get())}return this.lastToken=t,t&&x.isText(t)&&this._setKerning(t),t},getTextTokenLength:function(){return this.bodyTokens.length},getInlineFontSize:function(){return this.context.getInlineFontSize(this.parent)},getRestMeasure:function(){return this.parent.getContentMeasure()-this.curMeasure},getParentFlow:function(){return this.parent.flow},addStyle:function(t){this.context.addStyle(t)},addElement:function(t,e){e.fontSize>this.maxFontSize&&this._setMaxFontSize(e.fontSize),e.extent>this.maxExtent&&this._setMaxExtent(e.extent),e.advance>0&&this._addAdvance(e.advance),t instanceof C?this._addRuby(t):x.isTag(t)?this._addTag(t):"inline-block"===t._type?this._addInlineBlock(t):this._addText(t)
},setAnchor:function(t){this.context.setAnchor(t)},setLineBreak:function(){this.lastText=null,this.lineBreak=!0},createInlineRoot:function(){return this.context.createInlineRoot()},createLine:function(){this.isFirstLine()&&this.popFirstLine(),this.isOverWithoutLineBreak()&&this.justify(this.lastToken);var t=this._createTextLine();if(this.isRubyLine)return t;var e=this._createRubyLine(t);return this._createLineBox(t,e)},justify:function(t){var e=t,n=this.stream.findTextPrev(),i=this.getTextTokenLength();e&&x.isChar(e)&&e.isHeadNg()&&(this.bodyTokens=this._justifyHead(e),this.getTextTokenLength()!=i&&(n=this.stream.findTextPrev())),n&&x.isChar(n)&&n.isTailNg()&&(this.bodyTokens=this._justifyTail(n))},_addAdvance:function(t){this.curMeasure+=t,this.restMeasure-=t},_setMaxExtent:function(t){this.maxExtent=t},_setMaxFontSize:function(t){this.maxFontSize=t,this.isRubyLine||(this.rubyLineExtent=Math.floor(t*this.rubyLineRate))},_setKerning:function(t){if(this.prevText=this.lastText,this.lastText=t,x.isChar(t))if(t.isKakkoStart())this._setKerningStart(t,this.prevText);else if(t.isKakkoEnd()||t.isKutenTouten()){var e=this.stream.findTextNext(t.pos);this._setKerningEnd(t,e)}},_setKerningStart:function(t,e){var n=this._getTextSpaceStart(t,e);n>0&&(t.spaceRateStart=n)},_setKerningEnd:function(t,e){var n=this._getTextSpaceEnd(t,e);n>0&&(t.spaceRateEnd=n)},_getTextSpaceStart:function(t,e){return null===e?.5:x.isChar(e)&&e.isKakkoStart()?0:.5},_getTextSpaceEnd:function(t,e){return null===e?.5:x.isChar(e)&&(e.isKakkoEnd()||e.isKutenTouten())?0:.5},_addRuby:function(t){this.bodyTokens=this.bodyTokens.concat(t.getRbs()),this.rubyTokens.push(t)},_addTag:function(t){this.bodyTokens.push(t)},_addInlineBlock:function(t){this.bodyTokens.push(t)},_addEmpha:function(t,e){var n=t.getCssAttr("empha-mark")||"&#x2022;";this.emphaChars.push(new _({data:n,parent:e,startPos:this.curMeasure}))},_addText:function(t){this.bodyTokens.push(t),this.charCount+=t.getCharCount();var e=this.context.findInlineTag(function(t){return t.isEmphaTag()});e&&this._addEmpha(e,t)},_justifyHead:function(t){var e=0;if(this.stream.iterWhile(t.pos,function(t,n){return x.isChar(n)&&n.isHeadNg()?(e++,!0):!1}),0>=e)return this.bodyTokens;if(1===e)return this.bodyTokens.push(t),this.stream.setPos(t.pos+1),this.bodyTokens;var n=-1;if(this.stream.revIterWhile(t.pos,function(t,e){return this.lineStartPos>=t?!1:x.isChar(e)&&!e.isHeadNg()?(n=t,!1):!0}),0>n)return this.bodyTokens;for(var i=t.pos;i>n;)this.bodyTokens.pop(),i--;return this.stream.setPos(n),this.bodyTokens},_justifyTail:function(t){var e=0;if(this.stream.revIterWhile(t.pos,function(t,n){return x.isChar(n)&&n.isTailNg()?(e++,!0):!1}),0>=e)return this.bodyTokens;if(1===e)return this.bodyTokens.pop(),this.stream.setPos(t.pos),this.bodyTokens;var n=-1;if(this.stream.revIterWhile(t.pos,function(t,e){return this.lineStartPos>=t?!1:x.isChar(e)&&!e.isTailNg()?(n=t,!1):!0}),0>n)return this.bodyTokens;for(var i=t.pos;i>n;)this.bodyTokens.pop(),i--;return this.stream.setPos(n+1),this.bodyTokens},_createTextLine:function(){var t=this.parent.flow.getBoxSize(this.lineMeasure,this.maxExtent);return new $({type:"text-line",parent:this.parent,size:t,charCount:this.charCount,fontSize:this.parent.fontSize,color:this.parent.color,tokens:this.bodyTokens,textMeasure:this.curMeasure,textIndent:this.textIndent,letterSpacing:this.letterSpacing,lineRate:1})},_createRubyLine:function(t){var e=this.parent.flow.getBoxSize(this.lineMeasure,this.rubyLineExtent);return new $({type:"ruby-line",parent:this.parent,size:e,charCount:0,fontSize:this.parent.fontSize,color:this.parent.color,tokens:this.rubyTokens,emphaChars:this.emphaChars,textMeasure:this.curMeasure,textIndent:this.textIndent,letterSpacing:this.letterSpacing,lineRate:this.rubyLineRate,bodyLine:t})},_createLineBox:function(t,e){return new Z({extent:this.maxExtent+this.rubyLineExtent,parent:this.parent,rubyLine:e,textLine:t})}},t}(),Re=function(){function t(t,e,n){this.markup=t,this.stream=e,this.context=n,this._hasNext=this.stream.hasNext()}var e=k.BUFFER_END,n=k.SKIP,i=k.LINE_BREAK,r=k.RETRY,s=k.IGNORE,a=k.BREAK;return t.prototype={hasNext:function(){return this._hasNext?this.generator&&this.generator.hasNext()?!0:this.stream.hasNext():!1},backup:function(){this.stream.backup()},rollback:function(){this.stream.rollback(),this.generator=null},yield:function(t){var o=new Ae(t,this.stream,this.context);if(!o.canContainBasicLine())return a;for(this.backup();;){var u=this._yieldElement(o);if(u==e){o.setLineBreak();break}if(u==n)return s;if(u==i){o.setLineBreak();break}if(u==r){o.setLineBreak();break}if(u!=s){var h=this._getAdvance(o,u),l=this._getExtent(o,u),c=this._getFontSize(o,u);if(!o.canContain(h,l)){this.generator?this.generator.rollback():o.pushBackToken();break}o.addElement(u,{advance:h,extent:l,fontSize:c})}}return o.createLine()},_getExtent:function(t,e){return x.isText(e)?e.fontSize:e instanceof C?e.getExtent():e instanceof X?e.getBoxExtent(t.getParentFlow()):0},_getFontSize:function(t,e){return x.isText(e)?e.fontSize:e instanceof C?e.getFontSize():0},_getAdvance:function(t,e){return x.isText(e)?e.getAdvance(t.getParentFlow(),t.letterSpacing):x.isTag(e)?0:e instanceof C?e.getAdvance(t.getParentFlow()):e.getBoxMeasure(t.getParentFlow())},_yieldElement:function(t){if(this.generator&&this.generator.hasNext())return this.generator.yield(t);this.generator=null;var e=t.getNextToken();return this._yieldToken(t,e)},_yieldToken:function(t,r){if(null===r)return e;if(x.isChar(r)&&r.isNewLineChar())return t.isPreLine()?i:s;if(x.isText(r))return this._yieldText(t,r);if(x.isTag(r)&&"br"===r.getName())return i;if(this.markup&&r.isPseudoElementTag()){var a=r.getPseudoElementName();this.markup.copyPseudoStyle(a,r)}return r.isBlock()?(t.pushBackToken(),this._hasNext=!1,t.isEmptyText()?n:i):r.hasStaticSize()?this._yieldStaticInlineBlock(t,r):r.isInlineBlock()?(this.generator=new Ie(r,t.createInlineRoot()),this.generator.yield(t)):this._yieldInlineTag(t,r)},_yieldStaticInlineBlock:function(t,e){var n=Le.prototype._yieldStaticElement.call(this,t.parent,e,this.context);return n instanceof X&&(n.display="inline-block"),n},_yieldText:function(t,e){switch(e.hasMetrics()||e.setMetrics(t.getParentFlow(),t.getInlineFontSize(),t.isBoldEnable()),e._type){case"char":case"tcy":return e;case"word":return this._yieldWord(t,e)}},_yieldInlineTag:function(t,e){switch(e.getName()){case"script":return s;case"style":return t.addStyle(e),s;case"ruby":return e.fontSize===void 0&&(e.fontSize=t.getInlineFontSize(),e.letterSpacing=t.letterSpacing),this.generator=new Pe(e),this.generator.yield(t);case"a":var n=e.getTagAttr("name");n&&t.setAnchor(n);break;default:}return e.isSingleTag()||e.parsed?e:(e.isOpen()?t.pushTag(e):t.popTagByName(e.getOpenTagName()),e.parsed=!0,e)},_yieldWord:function(t,e){var n=e.getAdvance(t.getParentFlow(),t.letterSpacing);if(t.maxMeasure>=n)return e;var i=t.getInlineFontSize(),r=t.isBoldEnable(),s=t.getParentFlow(),a=e.cutMeasure(t.maxMeasure);return e.setMetrics(s,i,r),a.setMetrics(s,i,r),a}},t}(),Le=we.extend({init:function(t,e){this._super(t,e),this.generator=null,this.rollbackCount=0,this.stream=this._createStream(),this.localPageNo=0,this.pageBreakBefore=this._isPageBreakBefore()},hasNext:function(){return this.generator&&this.generator.hasNext()?!0:this.stream.hasNext()},backup:function(){this.generator&&this.generator.backup()},rollback:function(){if(this.rollbackCount++,this.rollbackCount>n.maxRollbackCount)throw"too many rollbacks";this.generator&&this.generator.rollback()},yield:function(t,e){if(this.stream.isEmpty())return k.SKIP;if(this.pageBreakBefore)return this.pageBreakBefore=!1,k.PAGE_BREAK;this.context.pushBlock(this.markup);var n,i;i=e||(t?t.getRestSize():null),n=this._createBox(i,t);var r=this._yieldPageTo(n);return this.context.popBlock(),r},_yieldPageTo:function(t){for(var e=0,n=t.getContentExtent(),i=t.flow;;){this.backup();var r=this._yieldPageElement(t);if(r==k.PAGE_BREAK)break;if(r==k.BUFFER_END)break;if(r==k.SKIP)break;if(r==k.RETRY){this.rollback();break}if(r==k.BREAK)break;if(r!=k.IGNORE){var s=r.getBoxExtent(i);if(e+=s,e>n||this._isEmptyElement(i,r)){this.rollback();break}if(t.addChild(r),e==n)break;if(r.pageBreakAfter){t.pageBreakAfter=!0;break}}}return this.localPageNo>0&&t.clearBorderBefore(),this.hasNext()?t.clearBorderAfter():this._onLastPage(t),this.rollbackCount=0,this._onCompletePage(t),e>0&&this.localPageNo++,t},_isPageBreakBefore:function(){return"always"===this.markup.getCssAttr("page-break-before","")},_isEmptyElement:function(t,e){return e instanceof X&&0>=e.getContentExtent(t)},_createStream:function(){var t=this._createSource(this.markup.content);return new ge(t)},_createSource:function(t){return t.replace(/^[ \n]+/,"").replace(/\s+$/,"").replace(/\r/g,"")},_onLastPage:function(){},_onCompletePage:function(){},_yieldPageElement:function(t){if(this.generator&&this.generator.hasNext())return this.generator.yield(t);var e=this.stream.get();return null===e?k.BUFFER_END:x.isChar(e)&&e.isNewLineChar()?k.IGNORE:x.isTag(e)&&e.isPageBreakTag()?k.PAGE_BREAK:x.isInline(e)?(this.stream.prev(),this.generator=new Re(this.markup,this.stream,this.context),this.generator.yield(t)):this._yieldBlockElement(t,e)},_yieldBlockElement:function(t,e){if(e.hasStaticSize())return this._yieldStaticTag(t,e);if(e.hasFlow()&&e.getCssAttr("flow")!=t.getFlowName()){var n=t.getRestSize(),i=new Oe(e,this.context.createInlineRoot());return i.yield(t,n)}return this.generator=this._createChildPageGenerator(t,e),this.generator.yield(t)},_yieldStaticTag:function(t,e){var n=this._yieldStaticElement(t,e,this.context);return n instanceof X?e.isPush()?n:n instanceof X&&n.blockAlign?this._yieldAlignedBlock(t,n,e):n:n},_yieldStaticElement:function(t,e,n){var r,s=e.getStaticSize(t.fontSize||i.fontSize,t.getContentMeasure());return r="img"===e.getName()?new Ee(e,n):e.hasFlow()?new Oe(e,n.createInlineRoot()):new Be(e,n),r.yield(t,s)},_yieldAlignedBlock:function(t,e){var n=new We(this.stream,this.context,e),i=n.yield(t);return this.generator=n.getCurGenerator(),i},_createChildPageGenerator:function(t,e){switch(e.getName()){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":return this._getHeaderLineGenerator(t,e);case"section":case"article":case"nav":case"aside":return this._getSectionContentGenerator(t,e);case"details":case"blockquote":case"figure":case"fieldset":return this._getSectionRootGenerator(t,e);case"table":return this._getTableGenerator(t,e);case"tbody":case"thead":case"tfoot":return this._getTableRowGroupGenerator(t,e);case"tr":return this._getTableRowGenerator(t,e);case"dl":return this._getDefListGenerator(t,e);case"ul":case"ol":return this._getListGenerator(t,e);case"li":return this._getListItemGenerator(t,e);case"hr":return this._getHorizontalRuleGenerator(t,e);default:return new Ne(e,this.context)}},_getSectionContentGenerator:function(t,e){return new Me(e,this.context)},_getSectionRootGenerator:function(t,e){return new Fe(e,this.context)},_getHorizontalRuleGenerator:function(t,e){return new ze(e,this.context)},_getHeaderLineGenerator:function(t,e){return new He(e,this.context)},_getListGenerator:function(t,e){return new qe(e,this.context)},_getListItemGenerator:function(t,e){return new Xe(e,t,this.context)},_getDefListGenerator:function(t,e){return new Ye(e,this.context)},_getTableGenerator:function(t,e){return new De(e,this.context)},_getTableRowGroupGenerator:function(t,e){return new je(e,this.context)},_getTableRowGenerator:function(t,e){return new Ue(e,t,this.context.createInlineRoot())}}),Ie=Le.extend({init:function(t,e){this.markup=t,this.context=e,this.stream=this._createStream()},_getBoxType:function(){return"inline-block"},yield:function(t){var e=t.restMeasure,n=t.restExtent,i=t.getParentFlow(),r=i.getBoxSize(e,n),s=this._createBox(r,t.parent);return s=this._yieldPageTo(s),"number"==typeof s?s:(s.shortenBox(),s.isTextVertical()||(s.display="inline-block"),s)}}),Ne=Le.extend({_onCompletePage:function(t){t.shortenExtent(t.getParentFlow())}}),Me=Ne.extend({init:function(t,e){this._super(t,e),this.context.logStartSection(t)},_onLastPage:function(){this.context.logEndSection(this.markup)}}),Fe=Ne.extend({init:function(t,e){this._super(t,e),this.context.startSectionRoot(t)},getOutlineTree:function(t){var e=t||this.markup.getName(),n=this.context.getOutlineLog(e),i=new re(n).yield();return i},getAnchors:function(){return this.context.getAnchors()},getAnchorPageNo:function(t){return this.context.getAnchorPageNo(t)},setAnchor:function(t,e){this.context.setAnchor(t,e)},_onLastPage:function(){this.context.endSectionRoot(this.markup)}}),He=Ne.extend({_onCompletePage:function(t){this._super(t),t.id=g.addNehanHeaderPrefix(this.context.logSectionHeader(this.markup))},_onCompleteBox:function(t){t.addClass("nehan-header")}}),Ve=Fe.extend({init:function(t,e){var n=e||new le,i=t;"string"==typeof t&&(i=new b("<body>",t)),this._super(i,n)},_createBox:function(){var t=i.createStdBox("body");return this._setBoxStyle(t),t.percent=this.stream.getSeekPercent(),t.seekPos=this.stream.getSeekPos(),t.pageNo=this.context.getPageNo(),t.charPos=this.context.getCharPos(),t.lazy=this.context.isEmptyMarkupContext(),t.css["font-size"]=i.fontSize+"px",t},_onCompletePage:function(t){t.styles=this.context.getPageStyles(t.pageNo),t.lazy=t.lazy&&this.context.isEmptyMarkupContext(),this.context.stepPageNo(),this.context.addCharPos(t.getCharCount())}}),We=Le.extend({init:function(t,e,n){this.context=e,this.stream=t,this.alignedBox=n},yield:function(t){var e=this.stream.backupPos,n=this._getAlignedWrapBox(t,this.alignedBox),i=this._getAlignedRestSize(t,n,this.alignedBox),r=this._createBox(i,n,t),s=this._yieldPageTo(r);return"start"===this.alignedBox.blockAlign?(n.addChild(this.alignedBox),n.addChild(s)):(n.addChild(s),n.addChild(this.alignedBox)),this.stream.backupPos=e,n},_createBox:function(t,e,n){var r=i.createBox(t,e,"box");if(r.setFlow(n.flow),"start"===this.alignedBox.blockAlign){var s=new G,a=i.getAlignedSpacingSize();s.setEdgeStart("margin",r.flow,a),r.setEdgeBySub(s)}return r},_getAlignedWrapBox:function(t,e){var n=t.getContentMeasure(),r=e.getBoxExtent(t.flow),s=t.flow.getBoxSize(n,r),a=i.createBox(s,t,"box"),o=t.getAlignedWrapFlow();return a.setParent(t,!1),a.setFlow(o),e.setParent(a,!0),a},_getAlignedRestSize:function(t,e,n){var i=t.getContentMeasure()-n.getBoxMeasure(t.flow),r=n.getBoxExtent(t.flow);return t.flow.getBoxSize(i,r)}}),Oe=Le.extend({hasNext:function(){return!1},yield:function(t,e){this._onReadyMarkupEvent(t);var n=this._getBoxType(),r=i.createBox(e,t,n);return this._onReadyBox(r),this._onReadyBoxEvent(r),this._setBoxStyle(r,t),this._onCompleteBox(r,t),this._yieldPageTo(r)}}),Ge=Ne.extend({init:function(t,e,n,i){this.generators=t,this.markup=e,this.context=n,this.partition=i},hasNext:function(){return u.exists(this.generators,function(t){return t.hasNext()})},backup:function(){u.iter(this.generators,function(t){t.backup()})},rollback:function(){u.iter(this.generators,function(t){t.rollback()})},yield:function(t){this.backup();var e=t.getRestSize(),n=this._createBox(e,t),i=t.getParallelFlow();return n.setFlow(i),this._yieldChilds(n,t)},_setEdge:function(){},_getChildMeasure:function(t){return this.partition.getSize(t)},_getChildExtent:function(t){return t.getRestContentExtent()},_yieldChilds:function(t,e){var n=this,i=e.flow,r=function(t){return t&&t.getContentExtent},s=u.mapi(this.generators,function(r,s){var a=n._getChildMeasure(r),o=n._getChildExtent(e),u=i.getBoxSize(a,o);return s.yield(t,u)});if(!u.exists(s,r))return k.RETRY;var a=u.maxobj(s,function(t){return t&&t.getContentExtent?t.getContentExtent():0}),o=a.getContentExtent(),h=a.getBoxExtent();return t.setContentExtent(e.flow,h),u.iter(s,function(e){e&&(e.setContentExtent(i,o),t.addChild(e))}),t}}),Ke=Ne.extend({_onReadyBox:function(t,e){var n=e.getParallelFlipFlow();t.setFlow(n)}}),De=Ne.extend({_createStream:function(){return new xe(this.markup)},_onReadyBox:function(t){"collapse"===this.markup.getCssAttr("border-collapse")&&this.collapse===void 0&&(fe.set(this.markup,t),this.collapse=!0)},_onCompleteBox:function(t){t.partition=this.stream.getPartition(t)}}),je=Ne.extend({_onCompleteBox:function(t,e){t.partition=e.partition},_createStream:function(){return new pe(this.markup.childs)}}),Ue=Ge.extend({init:function(t,e,n){var i=e.partition.getPartition(t.childs.length),r=u.map(t.childs,function(t){return new Ke(t,n.createInlineRoot())});this._super(r,t,n,i)}}),qe=Ne.extend({_onCompleteBox:function(t,e){var n=this.stream.getTokenCount(),i=this.markup.getCssAttr("list-style-type","none"),r=this.markup.getCssAttr("list-style-position","outside"),s=this.markup.getCssAttr("list-style-image","none"),a=new P({type:i,position:r,imageURL:s}),o=a.getMarkerAdvance(e.fontSize,n);t.listStyle=a,t.partition=new K([o,t.getContentMeasure()-o])},_createStream:function(){return new ye(this.markup.content)}}),Xe=Ge.extend({init:function(t,e,n){var i=e.listStyle;t.marker=i.getMarker(t.order),i.isInside()&&(t.content=t.marker+f.space+t.content,t.marker=f.space),this._super([new Ze(t,n),new $e(t,n)],t,n,e.partition)}}),Ze=Ke.extend({_getBoxType:function(){return"li-marker"},_createStream:function(){return new ge(this.markup.marker)}}),$e=Ke.extend({_getBoxType:function(){return"li-body"}}),Ye=Ne.extend({_createStream:function(){return new ve(this.markup.content)}}),Je=function(){function t(t){m.merge(this,{html:"",groupLength:1,seekPos:0,pageNo:0,charPos:0,charCount:0,percent:0},t)}return t.prototype={isGroup:function(){return this.groupLength>1},getGroupCount:function(){return this.groupLength},getPageCount:function(){return this.isGroup()&&this.html instanceof Array?this.html.length:1},getHtml:function(t){return this.isGroup()?this.html[t]||"":this.html}},t}(),Qe=function(){function t(t){this.ctx=t||new le,this.blockEvaluator=new tn(this.ctx)}return t.prototype={evaluate:function(t){var e=this.blockEvaluator.evaluate(t,this.ctx),n=u.fold(t.styles,"",function(t,e){return t+e.getWrapSrc()});return new Je({html:[n,e].join(""),percent:t.percent,seekPos:t.seekPos,pageNo:t.pageNo,charPos:t.charPos,charCount:t.charCount})}},t}(),tn=function(){function t(){this.inlineEvaluatorH=new rn(this),this.inlineEvaluatorV=new nn(this)}return t.prototype={evaluate:function(t,e){switch(t._type){case"br":return this.evalBreak(t,e);case"hr":return this.evalHorizontalRule(t,e);case"ibox":return this.evalInlineBox(t,e);case"ipage":return this.evalInlinePage(t,e);case"img":return this.evalImage(t,e);case"table":return this.evalTable(t,e);case"line-box":return this.evalLineBox(t,e);case"text-line":case"ruby-line":return this.evalLine(t,e);default:return this.evalBox(t,e)}},evalBox:function(t,e){var n={style:g.attr(t.getCss()),"class":t.getCssClasses()};return t.id&&(n.id=t.id),d.tagWrap("div",this.evalBoxChilds(t.getChilds(),e),n)},evalBoxChilds:function(t,e){var n=this;return u.fold(t,"",function(t,i){return[t,n.evaluate(i,e)].join("\n")})},evalLineBox:function(t,e){var n=this;return u.fold(t.getLines(),"",function(t,i){return t+n.evalLine(i,e)})},evalLine:function(t,e){return t.isTextVertical()?this.inlineEvaluatorV.evaluate(t,e):this.inlineEvaluatorH.evaluate(t,e)},evalInlineBox:function(t){return d.tagWrap("div",t.content,{style:g.attr(t.getCss()),"class":t.getCssClasses()})},evalHorizontalRule:function(t,e){return this.evalInlineBox(t,e)},evalBreak:function(t,e){return this.evalInlineBox(t,e)},evalImage:function(t,e){var n=this.evalImageContent(t,e);return d.tagWrap("div",n,{style:g.attr(t.getCss()),"class":t.getCssClasses()})},evalImageContent:function(t){return d.tagSingle("img",{src:t.src,width:t.getContentWidth(),height:t.getContentHeight()})},evalInlinePage:function(t,e){var n=e.createInlineRoot();return this.evalBox(t,n)},evalTable:function(t,e){var n=e.createInlineRoot();return this.evalBox(t,n)}},t}(),en=o.extend({init:function(t){this.parentEvaluator=t},evaluate:function(t,e){switch(t._type){case"text-line":return this.evalTextLine(t,e);case"ruby-line":return this.evalRubyLine(t,e)}},evalTextLine:function(t,e){return d.tagWrap("div",this.evalTextLineBody(t,e),{style:g.attr(t.getCss()),"class":t.getCssClasses()})},evalTextLineBody:function(t,e){var n=this;return[this.evalOpenTagStack(t,e),u.fold(t.tokens,"",function(i,r){return i+n.evalInlineElement(t,r,e)}),this.evalCloseTagStack(t,e)].join("")},evalRubyLine:function(t,e){var n=this.evalRubyLineBody(t,e),i=this.evalEmphaChars(t,e);return d.tagWrap("div",n+i,{style:g.attr(t.getCss()),"class":t.getCssClasses()})},evalEmphaChars:function(t,e){var n=this;return u.fold(t.emphaChars,"",function(i,r){return i+n.evalEmphaChar(t,r,e)})},evalRubyLineBody:function(t,e){var n=this;return u.fold(t.tokens,"",function(i,r){return i+n.evalRubyLabel(t,r,e)})},evalRubyLabel:function(){throw"not implemented:evalRubyLabel"},evalEmphaChar:function(){throw"not implemented:evalEmphaChar"},evalOpenTagStack:function(t,e){var n=this,i=e.getInlineTagStack();return u.fold(i.tags,"",function(i,r){return i+n.evalTagOpen(t,r,e,!1)})},evalCloseTagStack:function(t,e){var n=this,i=e.getInlineTagStack();return u.fold(i.tags,"",function(i,r){return i+n.evalTagClose(t,r.getCloseTag(),e,!1)})},evalInlineElement:function(t,e,n){return x.isText(e)?this.evalText(t,e,n):x.isTag(e)?this.evalTag(t,e,n):e instanceof X?this.evalInlineBox(e,n):""},evalText:function(t,e,n){switch(e._type){case"word":return this.evalWord(t,e,n);case"tcy":return this.evalTcy(t,e,n);case"char":return this.evalChar(t,e,n);default:return""}},evalTag:function(t,e,n){return e.isSingleTag()?this.evalTagSingle(t,e,n):e.isOpen()?this.evalTagOpen(t,e,n,!0):this.evalTagClose(t,e,n,!0)},evalTagOpen:function(t,e,n,i){return i&&n.pushInlineTag(e,t),this.evalTagOpenBody(t,e,n)},evalTagCss:function(t,e){var n={};return e.fontSize&&(n["font-size"]=e.fontSize+"px",n["line-height"]="1em"),e.fontColor&&(n.color=e.fontColor),n},evalTagStart:function(t,e,n,i){var r={},s=this.evalTagCss(t,e,n),a=e.getName();return e.addClass(g.addNehanPrefix(a)),r["class"]=e.getCssClasses(),h.isEmpty(s)||(r.style=g.attr(s)),d.tagStart(i||a,r)},evalTagEnd:function(){throw"not implemented:evalTagEnd"},evalTagOpenBody:function(t,e,n){switch(e.getName()){case"a":return this.evalLinkStart(t,e,n);default:return this.evalTagStart(t,e,n)}},evalTagClose:function(t,e,n,i){var r=e.getOpenTagName(),s=i?n.popInlineTagByName(r):n.findLastInlineTagByName(r);return null===s?"":this.evalTagCloseBody(t,e,n)},evalTagCloseBody:function(t,e,n){switch(e.getName()){case"/a":return"</a>";default:return this.evalTagEnd(e,n)}},evalTagSingle:function(t,e){return e.getSrc()},evalInlineBox:function(t,e){return this.parentEvaluator.evaluate(t,e)},evalLinkStart:function(t,e){var n={};n.href=e.getTagAttr("href","#");var i=e.getTagAttr("name");i&&(e.addClass("nehan-anchor"),n.name=i);var r=e.getTagAttr("target");return r&&(n.target=r),n.href.indexOf("#")>=0&&e.addClass("nehan-anchor-link"),n["class"]=e.getCssClasses(),d.tagStart(e.getName(),n)},evalWord:function(){throw"not implemented: evalWord"},evalTcy:function(){throw"not implemented: evalTcy"},evalChar:function(){throw"not implemented: evalChar"}}),nn=en.extend({evalTextLine:function(t,e){return t.getCss(),d.tagWrap("div",this.evalTextLineBody(t,e),{style:g.attr(t.getCss()),"class":t.getCssClasses()})},evalRubyLabel:function(t,e,n){var i=this.evalRubyLabelLine(t,e,n);return d.tagWrap("div",this.evalTextLine(i,n.createInlineRoot()),{style:g.attr(e.getCss(t)),"class":g.addNehanPrefix(e._type)})},evalEmphaChar:function(t,e){return d.tagWrap("div",e.data,{"class":"nehan-empha-char",style:g.attr(e.getCss(t.flow))})},evalRubyLabelLine:function(t,e,n){var i=e.getRtString(),r=e.getRtFontSize(),s=new ge(i),a=n.createInlineRoot();a.setFixedFontSize(r);var o=new Re(null,s,a);return o.yield(t)},evalTagStart:function(t,e,n){return this._super(t,e,n,"div")},evalTagEnd:function(){return"</div>"},evalWord:function(t,e,n){return r.isTransformEnable?this.evalWordTransform(t,e,n):r.isIE?this.evalWordIE(t,e,n):""},evalWordTransform:function(t,e){var n=d.tagWrap("div",e.data,{"class":"nehan-vert-alpha"});return d.tagWrap("div",n,{style:g.attr({"letter-spacing":t.letterSpacing+"px",width:e.fontSize+"px",height:e.bodySize+"px","word-break":"keep-all",overflow:"visible"})})},evalWordIE:function(t,e){var n={"writing-mode":"tb-rl","letter-spacing":t.letterSpacing+"px","line-height":e.fontSize+"px","float":"left"};return d.tagWrap("div",e.data,{style:g.attr(n)})},evalTcy:function(t,e){return d.tagWrap("div",e.data,{"class":"nehan-tcy"})},evalChar:function(t,e,n){return e.isImgChar()?r.isVerticalGlyphEnable&&!e.isTenten()?this.evalVerticalGlyph(t,e,n):this.evalImgChar(t,e,n):e.isHalfSpaceChar(e,n)?this.evalHalfSpaceChar(t,e,n):e.isCnvChar()?this.evalCnvChar(t,e,n):e.isSmallKana()?this.evalSmallKana(t,e,n):e.isPaddingEnable()?this.evalPaddingChar(t,e,n):this.evalCharBr(t,e,n)},evalCharBr:function(t,e){return t.letterSpacing?d.tagWrap("div",e.data,{style:g.attr({"margin-bottom":t.letterSpacing+"px"})}):e.data+"<br />"},evalPaddingChar:function(t,e){return d.tagWrap("div",e.data,{style:g.attr(e.getCssPadding(t.flow))})},evalImgChar:function(t,e,n){var r=e.fontSize,s=e.getVertScale(),a=1===s?r:Math.floor(r*s),o={};e.isPaddingEnable()&&m.copy(o,e.getCssPadding(t.flow));var u=i.fontColor.toUpperCase(),h=n.getInlineFontColor(t);return h!=i.fontColor&&(u=new T(h).getPaletteValueUpper()),d.tagSingle("img",{"class":"nehan-img-char",src:e.getImgSrc(u),style:g.attr(o),width:r,height:a})+f.clearFix},evalVerticalGlyph:function(t,e){var n=["nehan-vert-rl"];return e.isKakkoStart()?e.isPaddingEnable()||n.push("nehan-vert-kern-start"):(1>e.getVertScale()&&n.push("nehan-vert-half"),e.isPaddingEnable()&&n.push("nehan-vert-space-end")),d.tagWrap("div",e.data,{"class":n.join(" ")})},evalCnvChar:function(t,e){return e.cnv+"<br />"},evalSmallKana:function(t,e){return d.tagWrap("div",e.data,{style:g.attr({position:"relative",top:"-0.1em",right:"-0.12em",height:e.bodySize+"px","line-height":e.bodySize+"px"})})},evalHalfSpaceChar:function(t,e){var n=Math.floor(e.fontSize/2);return d.tagWrap("div","&nbsp;",{style:g.attr({height:n+"px","line-height":n+"px"})})},evalInlineBox:function(t,e){return this._super(t,e)+f.clearFix}}),rn=en.extend({evalRubyLabel:function(t,e){return d.tagWrap("span",e.getRtString(),{style:g.attr(e.getCss(t)),"class":g.addNehanPrefix(e._type)})},evalEmphaChar:function(t,e){return d.tagWrap("span",e.data,{"class":"nehan-empha-char",style:g.attr(e.getCss(t.flow))})},evalTagStart:function(t,e,n){return this._super(t,e,n,"span")},evalTagEnd:function(){return"</span>"},evalWord:function(t,e){return e.data},evalTcy:function(t,e){return e.data},evalChar:function(t,e,n){return e.isHalfSpaceChar()?e.cnv:e.isKerningChar()?this.evalKerningChar(t,e,n):e.data},evalKerningChar:function(t,e){var n=e.getCssPadding(t.flow);return e.isKakkoStart()?d.tagWrap("span",e.data,{style:g.attr(n),"class":"nehan-char-kakko-start"}):e.isKakkoEnd()?d.tagWrap("span",e.data,{style:g.attr(n),"class":"nehan-char-kakko-end"}):e.isKutenTouten()?d.tagWrap("span",e.data,{style:g.attr(n),"class":"nehan-char-kuto"}):e.data},evalPaddingChar:function(t,e){return d.tagWrap("span",e.data,{style:g.attr(e.getCssPadding(t.flow))})}}),sn=function(){function t(){this.evaluator=new Qe}return t.prototype={evaluate:function(t){var e=this,n=0,i=[],r=!0,s=u.map(t.getPages(),function(t){var s=e.evaluator.evaluate(t);return s.lazy||(r=!1),n+=s.charCount,i.push(s.html),s}),a=s[0];return new Je({html:i,groupLength:t.getSize(),percent:a.percent,seekPos:a.seekPos,charPos:a.charPos,charCount:n})}},t}(),an=o.extend({init:function(t){this.text=this._createSource(t),this.generator=this._createGenerator(this.text),this.evaluator=this._createEvaluator(),this.buffer=[],this._timeStart=null,this._timeElapsed=null,this._seekPageNo=0},hasPage:function(t){return this.buffer[t]!==void 0},hasNext:function(){return this.generator.hasNext()},getNext:function(){return this.hasNext()?(this.hasPage(this._seekPageNo)||this._addBuffer(this._yield()),this.get(this._seekPageNo++)):null},get:function(t){var e=this.buffer[t];if(e instanceof Je)return e;var n=this.evaluator.evaluate(e);return this.buffer[t]=n,n},getPageCount:function(){return this.buffer.length},getOutlineTree:function(t){return this.generator.getOutlineTree(t||"body")},getOutlineNode:function(t,e){var n=this.getOutlineTree(t),i=new se(n,e||{});return i.outputNode()},getAnchors:function(){return this.generator.getAnchors()},getAnchorPageNo:function(t){return this.generator.getAnchorPageNo(t)},setAnchor:function(t,e){this.generator.setAnchor(t,e)},getTimeElapsed:function(){return this._timeElapsed},syncGet:function(){for(this._setTimeStart();this.generator.hasNext();)this.getNext();return this._setTimeElapsed()},asyncGet:function(t){m.merge(this,{onComplete:function(){},onProgress:function(){}},t||{}),this._setTimeStart(),this._asyncGet(0,t.wait||0)},_yield:function(){return this.generator.yield()},_setTimeStart:function(){return this._timeStart=(new Date).getTime(),this._timeStart},_setTimeElapsed:function(){return this._timeElapsed=(new Date).getTime()-this._timeStart,this._timeElapsed},_asyncGet:function(t,e){if(!this.generator.hasNext()){var n=this._setTimeElapsed();return this.onComplete(n),void 0}var i=this,r=this._yield();this._addBuffer(r),this.onProgress(t,r.percent,r.seekPos),setTimeout(function(){i._asyncGet(t+1,e)},e)},_addBuffer:function(t){t.lazy||(t=this.evaluator.evaluate(t)),this.buffer.push(t)},_createSource:function(t){return t.replace(/(<[^>]+>)/g,function(t,e){return e.toLowerCase()}).replace(/(\/[a-z0-9\-]+>)[\s\n]+(<[^\/])/g,"$1$2").replace(/\t/g,"").replace(/<!--[\s\S]*?-->/g,"").replace(/<rp>[^<]*<\/rp>/g,"").replace(/<rb>/g,"").replace(/<\/rb>/g,"").replace(/<rt><\/rt>/g,"")},_createGenerator:function(t){return new Ve(t)},_createEvaluator:function(){return new Qe}}),on=an.extend({_createGenerator:function(t){return new Ce(t)}}),un=function(){function t(t){this.trees=[],this.size=t}return t.prototype={add:function(t){if(this.isComplete())throw"overflow";this.trees.push(t)},commit:function(){var t=this.getFirst(),e=this.getLast();this.lazy=t.lazy&&e.lazy,this.percent=t.percent,this.seekPos=t.seekPos,this.pageNo=t.pageNo},isEmpty:function(){return 0===this.trees.length},isComplete:function(){return this.trees.length>=this.size},getFirst:function(){return this.trees[0]},getLast:function(){return this.trees[this.trees.length-1]},get:function(t){return this.trees[t]},getPages:function(){return this.trees},getSize:function(){return this.size},getLength:function(){return this.trees.length}},t}(),hn=an.extend({init:function(t,e){this._super(t),this.groupSize=e},getAnchorPageNo:function(t){var e=this._super(t);return this.getGroupPageNo(e)},getGroupPageNo:function(t){return Math.floor(t/this.groupSize)},_yield:function(){for(var t=new un(this.groupSize),e=function(e){t.add(e)},n=0;this.groupSize>n&&this.generator.hasNext();n++)e(this.generator.yield());return t.commit(),t},_createEvaluator:function(){return new sn}});Nehan.version="4.0.0",m.update(r,e.env||{}),m.update(i,e.layout||{}),m.update(n,e.config||{});var ln={};return e.test&&(ln.Class=o,ln.Utils=c,ln.Obj=h,ln.Css=g,ln.Html=d,ln.Closure=p,ln.Args=m,ln.List=u,ln.Color=T,ln.Flow=A,ln.InlineFlow=L,ln.BlockFlow=R,ln.BoxFlow=I,ln.Edge=M,ln.Padding=V,ln.Margin=W,ln.Border=O,ln.BorderRadius=H,ln.Radius2d=F,ln.BoxEdge=G,ln.BoxSize=j,ln.LogicalSize=U,ln.UnitSize=l,ln.BoxChild=q,ln.Box=X,ln.Tag=b,ln.Char=y,ln.Word=v,ln.Tcy=S,ln.Ruby=C,ln.Lexer=Y,ln.Token=x,ln.TagStack=J,ln.InlineContext=ue,ln.BlockContext=oe,ln.DocumentContext=le,ln.TocContext=ee,ln.EvalResult=Je,ln.PageGroup=un,ln.Partition=K,ln.CardinalString=B,ln.CardinalStrings=E,ln.CardinalCounter=z,ln.ListStyle=P,ln.OutlineLog=ne,ln.OutlineContext=ie,ln.OutlineGenerator=re,ln.OutlineConverter=se,ln.TokenStream=ge,ln.DocumentTagStream=me,ln.HtmlTagStream=ke,ln.HeadTagStream=be,ln.ListTagStream=ye,ln.DefListTagStream=ve,ln.TableTagStream=xe,ln.RubyStream=Se,ln.BlockGenerator=we,ln.InlineGenerator=Re,ln.PageGenerator=Le,ln.BodyPageGenerator=Ve,ln.ParallelPageGenerator=Ge,ln.ParaChildPageGenerator=Ke,ln.HtmlGenerator=_e,ln.DocumentGenerator=Ce,ln.PageEvaluator=Qe,ln.BlockEvaluator=tn,ln.InlineEvaluator=en,ln.PageGroupEvaluator=sn,ln.PageStream=an,ln.PageGroupStream=hn,ln.DocumentPageStream=on),ln.Env=r,ln.Config=n,ln.Layout=i,ln.Style=s,ln.createPageStream=function(t){return new an(t)
},ln.createDocumentPageStream=function(t){return new on(t)},ln.createPageGroupStream=function(t,e){return new hn(t,e)},ln.addEventListener=function(t,e,n){a.addEventListener(t,e,n)},ln};